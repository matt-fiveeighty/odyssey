---
phase: 09-diff-view
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/diff/DiffView.tsx
  - src/components/diff/DiffItemCard.tsx
  - src/app/(app)/dashboard/page.tsx
  - src/lib/engine/advisor.ts
autonomous: true

must_haves:
  truths:
    - "Returning user with material diffs sees a 'What Changed' section above advisor insights on dashboard"
    - "Each diff item shows category icon, headline, interpretation with temporal prefix, recommendation, and CTA"
    - "User can dismiss all diffs with a 'Mark all as seen' action"
    - "First-time visitors and same-day visitors see no diff section"
    - "Temporal advisor insight is suppressed when diff items are displayed (no duplication)"
    - "No diff section renders when all diffs are seen or no material diffs exist (positive silence)"
  artifacts:
    - path: "src/components/diff/DiffView.tsx"
      provides: "Container component rendering diff items with header and dismiss-all action"
      min_lines: 30
    - path: "src/components/diff/DiffItemCard.tsx"
      provides: "Single diff item card with category icon, urgency styling, and CTA"
      min_lines: 25
    - path: "src/app/(app)/dashboard/page.tsx"
      provides: "DiffView integrated above advisor insights, diff computation in useMemo before recordVisit"
      contains: "computeDiffItems"
    - path: "src/lib/engine/advisor.ts"
      provides: "Temporal insight suppression when diff items exist"
      contains: "suppressTemporal"
  key_links:
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/lib/engine/diff-engine.ts"
      via: "import computeDiffItems, called in useMemo"
      pattern: "computeDiffItems"
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/components/diff/DiffView.tsx"
      via: "renders DiffView with items prop"
      pattern: "DiffView"
    - from: "src/components/diff/DiffItemCard.tsx"
      to: "src/lib/types/index.ts"
      via: "imports DiffItem, DiffCategory types"
      pattern: "DiffItem|DiffCategory"
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/lib/store.ts"
      via: "reads seenDiffIds, calls markAllDiffsSeen"
      pattern: "seenDiffIds|markAllDiffsSeen"
---

<objective>
Build DiffView and DiffItemCard components, integrate into the dashboard above advisor insights, and suppress the temporal advisor insight when diffs are active.

Purpose: This is the UI layer for Phase 9. The DiffView renders material diff items in a visually distinct section on the dashboard. It reuses AdvisorCard's urgency styling patterns for visual consistency while being semantically separate. The temporal advisor insight from Phase 5 is suppressed when diff items render to avoid duplication.

Output: DiffView.tsx, DiffItemCard.tsx components, dashboard integration, advisor.ts temporal suppression.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-diff-view/09-RESEARCH.md
@.planning/phases/09-diff-view/09-01-SUMMARY.md

@src/app/(app)/dashboard/page.tsx
@src/lib/engine/advisor.ts
@src/lib/engine/advisor-temporal.ts
@src/components/advisor/AdvisorCard.tsx
@src/lib/types/index.ts
@src/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DiffItemCard and DiffView components</name>
  <files>src/components/diff/DiffItemCard.tsx, src/components/diff/DiffView.tsx</files>
  <action>
**Create src/components/diff/DiffItemCard.tsx:**

A "use client" component that renders a single DiffItem. Reuse the urgency styling patterns from AdvisorCard but with category-specific styling for diff items.

Props: `{ item: DiffItem }`

Category-to-urgency mapping for styling:
- action_required -> immediate (red styling)
- warning -> soon (amber styling)
- opportunity -> informational (green styling)
- status_update -> positive (primary/blue styling)

Use the same URGENCY_STYLES record structure as AdvisorCard.tsx (copy the style map, don't import it -- it's not exported).

Category icons (from lucide-react):
- action_required: AlertTriangle
- warning: TrendingUp (point creep is the primary warning source)
- opportunity: Sparkles or Star (use Sparkles for new opportunities)
- status_update: Info

Layout (matches AdvisorCard structure for visual consistency):
```
[urgency dot] [category icon] [headline in urgency color]
                               [interpretation in muted text]
                               [recommendation in muted text]
                               [CTA button styled with urgency color]
```

The CTA should use Link for internal hrefs and `<a>` with target="_blank" for external hrefs (same pattern as AdvisorCard). Include ArrowRight icon for internal, ExternalLink icon for external.

**Create src/components/diff/DiffView.tsx:**

A "use client" component that renders the diff section container.

Props: `{ items: DiffItem[]; onDismissAll: () => void }`

Structure:
```
<Card with gradient top bar (from-chart-4 via-amber-500 to-destructive -- distinct from advisor's primary/chart-2/chart-5)>
  <div h-1 gradient bar />
  <CardContent p-4>
    <header row: flex items-center justify-between mb-3>
      <left: GitCompareArrows icon + "What Changed" title>
      <right: "Mark all as seen" button (text button, muted, calls onDismissAll)>
    </header>
    <div space-y-2>
      {items.map(item => <DiffItemCard key={item.id} item={item} />)}
    </div>
  </CardContent>
</Card>
```

Use GitCompareArrows from lucide-react for the section icon (visually distinct from Compass used for advisor section). If GitCompareArrows doesn't exist in the installed lucide-react version, use ArrowLeftRight instead.

Import Card, CardContent from @/components/ui/card. Import Button from @/components/ui/button.

The "Mark all as seen" button should be a small text button with variant="ghost" and size="sm".
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify both files exist and export their components. Check that DiffItemCard handles both internal and external CTAs. Check that DiffView renders the gradient bar, header with icon, dismiss button, and maps over items.
  </verify>
  <done>DiffItemCard renders a single diff item with category-specific urgency styling, advisor voice interpretation, recommendation, and clickable CTA. DiffView renders a card container with "What Changed" header, "Mark all as seen" dismiss action, and maps DiffItemCard for each item.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard integration and temporal insight suppression</name>
  <files>src/app/(app)/dashboard/page.tsx, src/lib/engine/advisor.ts</files>
  <action>
**In src/app/(app)/dashboard/page.tsx:**

1. Add imports:
```typescript
import { computeDiffItems } from "@/lib/engine/diff-engine";
import { DiffView } from "@/components/diff/DiffView";
import { STATES } from "@/lib/constants/states"; // already imported
```

2. Add `seenDiffIds` and `markAllDiffsSeen` to the useAppStore destructuring (line 99):
```typescript
const { ..., seenDiffIds, markAllDiffsSeen, lastDiffComputedAt } = useAppStore();
```

3. Add diff computation in a useMemo AFTER the temporal context useMemo but BEFORE the advisorInsights useMemo. This is critical: diff computation is synchronous (useMemo), so it reads lastVisitAt BEFORE the useEffect calls recordVisit().

```typescript
// Diff items (Phase 9) -- computed BEFORE recordVisit() fires
const diffItems = useMemo(() => {
  if (!confirmedAssessment || !temporal.isReturningUser) return [];
  return computeDiffItems(temporal, milestones, confirmedAssessment, userPoints, STATES, lastDiffComputedAt);
}, [confirmedAssessment, temporal, milestones, userPoints, lastDiffComputedAt]);

const unseenDiffs = useMemo(
  () => diffItems.filter(d => !seenDiffIds.includes(d.id)),
  [diffItems, seenDiffIds],
);
```

4. Pass `diffItems.length > 0` to generateAdvisorInsights to suppress temporal insights. Update the advisor insights useMemo to pass a suppressTemporal flag:

```typescript
const advisorInsights: AdvisorInsightType[] = useMemo(() => {
  if (!confirmedAssessment || !boardState || !health || !metrics) return [];
  return generateAdvisorInsights(
    boardState, health, metrics, violations, milestones,
    userPoints, temporal, confirmedAssessment, savingsGoals, userGoals,
    diffItems.length > 0,  // suppressTemporal -- avoid duplicating diff content
  );
}, [confirmedAssessment, boardState, health, metrics, violations, milestones, userPoints, temporal, savingsGoals, userGoals, diffItems]);
```

5. Add the DiffView section in the JSX, ABOVE the advisor insights section (after the Deadline Warning Banner, before the ADVISOR INSIGHTS comment block):

```tsx
{/* DIFF VIEW -- What Changed since last visit */}
{hasPlan && unseenDiffs.length > 0 && (
  <DiffView
    items={unseenDiffs}
    onDismissAll={() => markAllDiffsSeen(diffItems.map(d => d.id))}
  />
)}
```

**In src/lib/engine/advisor.ts:**

6. Add an optional `suppressTemporal` parameter (last parameter, default false) to `generateAdvisorInsights`:

```typescript
export function generateAdvisorInsights(
  boardState: BoardState,
  health: PortfolioHealthResult,
  metrics: StrategyMetrics,
  violations: DisciplineViolation[],
  milestones: Milestone[],
  userPoints: UserPoints[],
  temporal: TemporalContext,
  assessment: StrategicAssessment,
  savingsGoals: SavingsGoal[] = [],
  userGoals: UserGoal[] = [],
  suppressTemporal: boolean = false,
): AdvisorInsight[] {
```

7. Update the temporal insights call inside the function to respect the flag:
```typescript
const temporalInsights = suppressTemporal ? [] : generateTemporalInsights(temporal, milestones);
```

This uses a default parameter (false) so ALL existing call sites continue working unchanged. Only the dashboard passes true when diffs are active.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- build succeeds. Verify:
1. Grep dashboard/page.tsx for "computeDiffItems" to confirm import and useMemo call
2. Grep dashboard/page.tsx for "DiffView" to confirm component render
3. Grep dashboard/page.tsx for "unseenDiffs" to confirm seen-filtering
4. Grep advisor.ts for "suppressTemporal" to confirm the parameter and guard
5. Verify the DiffView renders ABOVE the advisor insights section in JSX order
6. Verify diffItems useMemo appears AFTER temporal useMemo but BEFORE advisorInsights useMemo
  </verify>
  <done>Dashboard shows DiffView above advisor insights for returning users with unseen material diffs. Diff computation happens in useMemo (synchronous, before recordVisit useEffect). "Mark all as seen" dismisses diffs via markAllDiffsSeen. Temporal advisor insight suppressed when diffs are active. First-time/same-day visitors see no diff section. Empty diff section renders nothing (positive silence).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. DiffView renders above advisor insights in dashboard JSX order
4. Temporal insight suppressed via suppressTemporal=true when diffItems.length > 0
5. seenDiffIds filtering ensures dismissed diffs don't reappear
6. markAllDiffsSeen receives all diff IDs (not just unseen) for complete tracking
7. No visual duplication between diff items and advisor temporal insight
</verification>

<success_criteria>
- DIFF-01: "Since your last visit" DiffView section renders above advisor insights, effectively replacing the temporal insight (which is suppressed)
- DIFF-02: Diff items sourced from all 4 sub-generators (via Plan 01's computeDiffItems)
- DIFF-03: Materiality filtering applied (via Plan 01's pipeline)
- DIFF-04: Category badges and advisor voice interpretation visible on each DiffItemCard
- DIFF-05: "Mark all as seen" persists seenDiffIds to AppState; dismissed diffs don't reappear
- Build succeeds, no type errors, all existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-diff-view/09-02-SUMMARY.md`
</output>
