---
phase: 07-scraper-enrichment-data-freshness
plan: 05
type: execute
wave: 4
depends_on: ["07-03", "07-04"]
files_modified:
  - src/components/results/sections/PortfolioOverview.tsx
  - src/components/results/sections/StatePortfolio.tsx
  - src/components/results/sections/LogisticsTab.tsx
  - src/components/results/sections/TimelineRoadmap.tsx
  - scripts/scrapers/base-scraper.ts
autonomous: true

must_haves:
  truths:
    - "Fee amounts in PortfolioOverview and LogisticsTab display a FreshnessBadge showing data provenance"
    - "Deadline dates in TimelineRoadmap and StatePortfolio display a FreshnessBadge"
    - "Stale data (>10 days) is visually flagged with a red dot and 'Stale' label throughout the results UI"
    - "DataSourceBadge with showLastUpdated=true appears on the dashboard showing when state data was last refreshed"
    - "The BaseScraper run() method uses guardAgainstDataLoss() before each upsert to prevent overwriting good data"
  artifacts:
    - path: "src/components/results/sections/PortfolioOverview.tsx"
      provides: "Fee amounts annotated with FreshnessBadge"
      contains: "FreshnessBadge"
    - path: "src/components/results/sections/StatePortfolio.tsx"
      provides: "Deadline dates annotated with FreshnessBadge and DataSourceBadge with last updated"
      contains: "FreshnessBadge"
    - path: "src/components/results/sections/LogisticsTab.tsx"
      provides: "Cost figures annotated with FreshnessBadge"
      contains: "FreshnessBadge"
    - path: "src/components/results/sections/TimelineRoadmap.tsx"
      provides: "Timeline dates annotated with FreshnessBadge"
      contains: "FreshnessBadge"
    - path: "scripts/scrapers/base-scraper.ts"
      provides: "run() uses guardAgainstDataLoss before upserts"
      contains: "guardAgainstDataLoss"
  key_links:
    - from: "src/components/results/sections/PortfolioOverview.tsx"
      to: "src/components/shared/FreshnessBadge.tsx"
      via: "Renders FreshnessBadge next to fee/cost amounts"
      pattern: "FreshnessBadge"
    - from: "src/components/results/sections/StatePortfolio.tsx"
      to: "src/components/shared/DataSourceBadge.tsx"
      via: "Renders DataSourceBadge with showLastUpdated on state cards"
      pattern: "DataSourceBadge.*showLastUpdated"
    - from: "scripts/scrapers/base-scraper.ts"
      to: "src/lib/scrapers/plausibility.ts"
      via: "guardAgainstDataLoss called before each upsert in run()"
      pattern: "guardAgainstDataLoss"
---

<objective>
Wire FreshnessBadge into the results UI wherever verified data is displayed (fees, deadlines, costs), add stale data visual flagging, add DataSourceBadge with "Data last updated" on state portfolio cards, and integrate the guardAgainstDataLoss safety check into BaseScraper's run() method.

Purpose: This is the final integration layer that connects all Phase 7 work into a user-visible outcome. Users will see provenance indicators on every data point, stale data will be visually flagged, and the scraper pipeline is protected against data loss. This satisfies FRESH-01 (badge displays), FRESH-02 (tooltip), FRESH-03 (stale flagging), and FRESH-04 (dashboard timestamp).

Output: Results UI components annotated with FreshnessBadge, DataSourceBadge with last-updated timestamps on state cards, and BaseScraper run() protected with data-loss guards.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-scraper-enrichment-data-freshness/07-03-SUMMARY.md
@.planning/phases/07-scraper-enrichment-data-freshness/07-04-SUMMARY.md

@src/components/results/sections/PortfolioOverview.tsx
@src/components/results/sections/StatePortfolio.tsx
@src/components/results/sections/LogisticsTab.tsx
@src/components/results/sections/TimelineRoadmap.tsx
@src/components/shared/FreshnessBadge.tsx
@src/components/shared/DataSourceBadge.tsx
@scripts/scrapers/base-scraper.ts
@src/lib/scrapers/plausibility.ts
@src/lib/engine/verified-datum.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire FreshnessBadge into results UI components for fee, deadline, and cost display</name>
  <files>src/components/results/sections/PortfolioOverview.tsx, src/components/results/sections/StatePortfolio.tsx, src/components/results/sections/LogisticsTab.tsx, src/components/results/sections/TimelineRoadmap.tsx</files>
  <action>
Read each component file first to understand the current structure and where data values are displayed.

**General approach for each component:** Identify where fee amounts, deadline dates, and cost figures are rendered. Where these values come from the engine (which may have VerifiedDatum-wrapped data), add a FreshnessBadge inline next to the value. Where values come from raw state constants (not yet VerifiedDatum-wrapped), create an `estimated()` wrapper on the fly for display purposes.

**PortfolioOverview.tsx:**
1. Find where total cost estimates, tag costs, and license fees are displayed.
2. Import `FreshnessBadge` from `@/components/shared/FreshnessBadge`.
3. Import `estimated` from `@/lib/engine/verified-datum`.
4. Next to each cost figure, add `<FreshnessBadge datum={estimated(value, "Cost calculator estimate")} showLabel={false} />`. This shows an amber "Estimated" dot inline.
5. If any values are already VerifiedDatum-wrapped (check the component's data flow), use the actual datum instead of wrapping with `estimated()`.
6. For the inflation rate display (if present), if it comes from the CPI API, it may already be VerifiedDatum-wrapped -- use that.

**StatePortfolio.tsx:**
1. Find where per-state deadline dates and fee amounts are displayed on state cards.
2. Add `<FreshnessBadge datum={estimated(value, "State fee schedule")} showLabel={false} />` next to fee amounts.
3. Add `<DataSourceBadge stateId={state.id} showLastUpdated />` at the bottom of each state card to show when state data was last refreshed.
4. For deadline dates, add inline FreshnessBadge.

**LogisticsTab.tsx:**
1. Find where cost breakdowns (flights, tags, licenses, total trip cost) are displayed.
2. Add FreshnessBadge next to each cost line item.
3. Flight costs may come from Amadeus (verified) or static estimates (estimated) -- use the appropriate wrapper.

**TimelineRoadmap.tsx:**
1. Find where timeline dates (application deadlines, draw results, season dates) are displayed.
2. Add FreshnessBadge next to each date.
3. Dates from state constants are estimated; dates from scraped data are verified.

**Stale data flagging (FRESH-03):**
The FreshnessBadge already handles this -- when `datum.isStale === true`, the badge renders as red with "Stale" label. Ensure that `showLabel` defaults to `true` (not false) for data points that could be stale, so users see the "Stale" text. For inline fee amounts where space is tight, use `showLabel={false}` (the red dot alone is sufficient).

**Important:**
- Do NOT refactor data flow to pass VerifiedDatum through every component. Use `estimated()` wrappers at the render boundary for values not yet wrapped. This is a deliberate incremental approach -- full VerifiedDatum plumbing through the engine is a future task.
- Keep FreshnessBadge usage subtle: small dots next to values, not large badges that break the layout.
- Test that the components still render correctly with `npx tsc --noEmit` after changes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes.
2. `grep -r "FreshnessBadge" src/components/results/sections/` returns matches in all 4 files.
3. `grep -r "DataSourceBadge.*showLastUpdated" src/components/results/sections/StatePortfolio.tsx` returns a match.
4. No layout breaking -- FreshnessBadge is used inline with `showLabel={false}` in tight spaces.
  </verify>
  <done>
All 4 results section components render FreshnessBadge next to cost figures, fee amounts, and deadline dates. StatePortfolio shows DataSourceBadge with "Data last updated" on each state card. Stale data displays red dots. Layout is preserved with inline compact badges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate guardAgainstDataLoss into BaseScraper run() method</name>
  <files>scripts/scrapers/base-scraper.ts</files>
  <action>
Modify the `run()` method in BaseScraper to use `guardAgainstDataLoss()` before each upsert operation.

**Import at top of file:**
```typescript
// NOTE: This import path depends on tsconfig resolution. If @/ doesn't work in scripts context,
// use relative path: "../../src/lib/scrapers/plausibility"
import { guardAgainstDataLoss } from "@/lib/scrapers/plausibility";
```

If `@/` path resolution doesn't work for scripts (check existing imports in base-scraper.ts), use relative path.

**Modify each upsert section in run():**

For each of the 7 upsert sections (units, draw history, deadlines, fees, seasons, regulations, leftover tags), add a guard check before the upsert:

**Example for deadlines (section 3):**
```typescript
// --- 3. Scrape & upsert deadlines ---
try {
  this.log("Scraping deadlines...");
  const deadlines = await this.scrapeDeadlines();
  if (deadlines.length > 0) {
    this.log(`  Found ${deadlines.length} deadlines`);
    // ... existing upsert code ...
  } else {
    // Guard: check if we're about to lose existing data
    const guard = await guardAgainstDataLoss(
      "scraped_deadlines", this.stateId, deadlines.length, this.supabase, this.log.bind(this)
    );
    if (!guard.safe) {
      errors.push(`deadlines: ${guard.reason}`);
    }
  }
}
```

Apply the same pattern to all 7 sections: units (ref_units), draw history (ref_unit_draw_history), deadlines (scraped_deadlines), fees (scraped_fees), seasons (scraped_seasons), regulations (scraped_regulations), leftover tags (scraped_leftover_tags).

**The key logic change:** When a scraper returns 0 rows, check existing data. If existing data exists, skip the upsert and log a warning. If no existing data, proceed normally (0 is genuinely 0).

**For units and draw history** (sections 1 and 2), the guard is especially important because these are the core data:
```typescript
// For units, if scraper returns 0 but DB has existing:
if (units.length === 0) {
  const guard = await guardAgainstDataLoss(
    "ref_units", this.stateId, 0, this.supabase, this.log.bind(this)
  );
  if (!guard.safe) {
    errors.push(`units: ${guard.reason}`);
    // Skip to next section -- don't try to upsert empty units
  }
}
```

**Important:**
- The guard only activates when the scraper returns 0 rows AND existing data exists in the DB.
- When the scraper returns > 0 rows, proceed normally (even if fewer than before -- the plausibility check for >80% drops is a warning, not a block).
- Don't wrap sections where data count > 0 in the guard -- the guard is specifically for the empty-data case.
  </action>
  <verify>
1. `npx tsc --noEmit` passes.
2. `grep "guardAgainstDataLoss" scripts/scrapers/base-scraper.ts` returns matches (at least 3-4 sections).
3. Import path for plausibility.ts resolves correctly (check with tsc).
4. `npx tsx scripts/scrapers/run-all.ts CO` runs without errors (Colorado is a good test since it has existing data).
  </verify>
  <done>
BaseScraper run() checks guardAgainstDataLoss before each upsert. When a scraper returns 0 rows but existing data exists in the DB, the upsert is skipped and a warning is logged. This prevents transient scraper failures from wiping good data. All existing scraper functionality preserved.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. FreshnessBadge appears in PortfolioOverview, StatePortfolio, LogisticsTab, TimelineRoadmap
3. DataSourceBadge with showLastUpdated appears in StatePortfolio
4. BaseScraper run() uses guardAgainstDataLoss for at least units, deadlines, fees, seasons sections
5. Stale data (datum.isStale=true) renders as red dot in FreshnessBadge
6. Provenance tooltip on FreshnessBadge shows source label, relative time, and "View source" link
7. `npm run build` succeeds (full Next.js build validates all components)
</verification>

<success_criteria>
- Every fee amount, deadline date, and cost figure in the results UI has an inline FreshnessBadge showing data provenance (FRESH-01)
- Hovering any FreshnessBadge shows source URL, scrape date, and confidence explanation (FRESH-02)
- Stale data (>10 days since scrape) is visually flagged with red dots and "Stale" label (FRESH-03)
- State portfolio cards show "Data last updated: {date}" via DataSourceBadge (FRESH-04)
- BaseScraper never overwrites good data with empty scrape results
- Full `npm run build` succeeds with all Phase 7 changes integrated
</success_criteria>

<output>
After completion, create `.planning/phases/07-scraper-enrichment-data-freshness/07-05-SUMMARY.md`
</output>
