---
phase: 10-scouting-strategy
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/lib/engine/calendar-grid.ts
  - src/lib/engine/advisor-scouting.ts
  - src/lib/engine/advisor.ts
  - src/components/results/sections/CalendarSlot.tsx
  - src/components/results/sections/StatePortfolio.tsx
  - src/components/results/ResultsShell.tsx
autonomous: true

must_haves:
  truths:
    - "Scouting hunts appear with a distinct visual treatment in the season calendar (violet badge, Binoculars icon, SCOUT HUNT label)"
    - "Scouting Move cards appear in the results UI showing the strategic connection between scout and trophy units"
    - "Advisor explains the scouting strategy with specific details (terrain, distance, years to draw)"
    - "Calendar slots for scouting hunts have scoutingTarget metadata for tooltip display"
  artifacts:
    - path: "src/lib/engine/advisor-scouting.ts"
      provides: "generateScoutingInsights sub-generator for advisor pipeline"
      exports: ["generateScoutingInsights"]
    - path: "src/lib/engine/calendar-grid.ts"
      provides: "scoutingTarget field on CalendarSlotData"
      contains: "scoutingTarget"
    - path: "src/components/results/sections/CalendarSlot.tsx"
      provides: "SCOUT HUNT badge rendering for scouting moves"
      contains: "SCOUT HUNT"
    - path: "src/components/results/sections/StatePortfolio.tsx"
      provides: "ScoutingMoveCard section below state cards"
      contains: "Scouting Move"
  key_links:
    - from: "src/lib/engine/advisor-scouting.ts"
      to: "src/lib/engine/scouting-engine.ts"
      via: "import ScoutingOpportunity"
      pattern: "ScoutingOpportunity"
    - from: "src/lib/engine/advisor.ts"
      to: "src/lib/engine/advisor-scouting.ts"
      via: "import generateScoutingInsights"
      pattern: "generateScoutingInsights"
    - from: "src/components/results/sections/StatePortfolio.tsx"
      to: "src/lib/engine/scouting-engine.ts"
      via: "import detectScoutingOpportunities, ScoutingOpportunity"
      pattern: "detectScoutingOpportunities"
---

<objective>
Wire scouting opportunities into the UI layer: ScoutingMoveCard presentation in results, distinct violet badge in the season calendar, and advisor voice integration with strategic explanations.

Purpose: Without this plan, the scouting engine has no user-visible output. This plan completes the feature by connecting engine output to calendar, advisor, and results presentation.

Output: ScoutingMoveCard in StatePortfolio, scouting badges in CalendarSlot, advisor-scouting.ts sub-generator wired into the pipeline, calendar scoutingTarget metadata.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-scouting-strategy/10-RESEARCH.md
@.planning/phases/10-scouting-strategy/10-01-SUMMARY.md
@src/lib/types/index.ts
@src/lib/engine/advisor.ts
@src/lib/engine/calendar-grid.ts
@src/components/results/sections/CalendarSlot.tsx
@src/components/results/sections/StatePortfolio.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Advisor scouting sub-generator + calendar scoutingTarget metadata</name>
  <files>
    src/lib/engine/advisor-scouting.ts
    src/lib/engine/advisor.ts
    src/lib/engine/calendar-grid.ts
  </files>
  <action>
**advisor-scouting.ts:**

Create a new advisor sub-generator following the exact same pattern as `advisor-creep.ts` and `advisor-savings.ts`.

Export `generateScoutingInsights(assessment: StrategicAssessment, scoutingOpps: ScoutingOpportunity[]): AdvisorInsight[]`

Logic:
- If `scoutingOpps` is empty, return `[]`
- Cap at 2 scouting insights (avoid overwhelming the feed)
- For each opportunity (up to 2, sorted by totalScore desc):
  - `id`: `"scouting-${opp.scoutUnit.stateId}-${opp.scoutUnit.speciesId}"`
  - `signal.type`: `"positive"` (scouting is an opportunity, not a warning)
  - `signal.message`: `"Scouting move: ${stateAbbr} ${formatSpeciesName(opp.scoutUnit.speciesId)}"`
  - `category`: `"scouting"`
  - `urgency`: `"informational"` (scouting is strategic, not time-sensitive)
  - `interpretation`: Build from opp data -- e.g., `"While you build ${opp.targetYearsAway} more years toward ${targetStateAbbr} Unit ${opp.targetUnit.unitCode}, hunt ${scoutStateAbbr} Unit ${opp.scoutUnit.unitCode} for scouting intel. ${opp.strategicReason}"`
  - `recommendation`: `"Apply for the ${drawAccessLabel} ${scoutStateAbbr} ${formatSpeciesName(opp.scoutUnit.speciesId)} tag. ${terrainContext}, fraction of the wait."`
    - `drawAccessLabel`: "OTC" if pointsRequiredNonresident === 0, "high-odds" otherwise
    - `terrainContext`: "Same terrain" if terrainOverlap.length > 0, else "Nearby hunting"
  - `cta`: `{ label: "View Scouting Move", href: "/plan-builder" }`
  - `portfolioContext`: `"Your ${targetStateAbbr} ${formatSpeciesName(opp.targetUnit.speciesId)} is ${opp.targetYearsAway} years away"`

Import `formatSpeciesName` from `@/lib/utils`, `STATES_MAP` from `@/lib/constants/states`, types from `@/lib/types` and `@/lib/engine/scouting-engine`.

**advisor.ts:**

1. Add import: `import { generateScoutingInsights } from "@/lib/engine/advisor-scouting";`
2. Add import: `import { detectScoutingOpportunities } from "@/lib/engine/scouting-engine";`
3. Add import: `import type { ScoutingOpportunity } from "@/lib/engine/scouting-engine";`
4. In `generateAdvisorInsights()`:
   - After the existing sub-generator calls, add:
     ```
     const scoutingOpps = detectScoutingOpportunities(assessment);
     const scoutingInsights = generateScoutingInsights(assessment, scoutingOpps);
     ```
   - Add `...scoutingInsights` to the `all` array (after `...savingsInsights`)
5. Do NOT change the function signature -- scouting detection runs internally from assessment data, no new parameters needed.

**calendar-grid.ts:**

1. Import `ScoutingTarget` from `@/lib/types`.
2. Add optional `scoutingTarget?: ScoutingTarget` field to `CalendarSlotData` interface (after `advisorNote`).
3. No changes to `buildCalendarGrid` -- scouting slots will be injected post-build (same post-build enrichment pattern as advisor notes from Phase 5). The actual injection happens in Plan 02 Task 2 (UI wiring) or can be done in the component layer.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors. Verify `generateScoutingInsights` is exported. Verify `advisor.ts` now calls `generateScoutingInsights` and includes results in the flattened array.
  </verify>
  <done>
    Advisor pipeline now includes an 8th sub-generator for scouting insights. CalendarSlotData has the scoutingTarget field. Scouting insights appear capped at 2 in the advisor feed, sorted by urgency with all other insights.
  </done>
</task>

<task type="auto">
  <name>Task 2: ScoutingMoveCard in results + calendar scouting badge</name>
  <files>
    src/components/results/sections/StatePortfolio.tsx
    src/components/results/sections/CalendarSlot.tsx
  </files>
  <action>
**StatePortfolio.tsx -- Add ScoutingMoveCard section:**

1. Import `detectScoutingOpportunities` from `@/lib/engine/scouting-engine` and `type ScoutingOpportunity` from `@/lib/engine/scouting-engine`.
2. Import `Binoculars` from `lucide-react`.
3. Import `ScoutingTarget` from `@/lib/types`.
4. Import `formatSpeciesName` from `@/lib/utils`.
5. Import `STATES_MAP` from `@/lib/constants/states`.

Create a `ScoutingMoveCard` component (within the same file, memoized):

```tsx
const ScoutingMoveCard = memo(function ScoutingMoveCard({ opp }: { opp: ScoutingOpportunity }) {
  const state = STATES_MAP[opp.scoutUnit.stateId];
  const targetState = STATES_MAP[opp.targetUnit.stateId];

  return (
    <div className="rounded-xl border border-violet-500/20 bg-violet-500/5 p-4">
      {/* Header badge */}
      <div className="flex items-center gap-2 mb-2">
        <Binoculars className="w-4 h-4 text-violet-400" />
        <span className="text-xs font-semibold uppercase tracking-wider text-violet-400">
          Scouting Move
        </span>
        {opp.distanceMiles != null && (
          <span className="text-[10px] text-muted-foreground ml-auto">
            ~{opp.distanceMiles} mi from target
          </span>
        )}
      </div>

      {/* Scout unit info */}
      <h3 className="text-base font-semibold">
        {state?.abbreviation ?? opp.scoutUnit.stateId} Unit {opp.scoutUnit.unitCode}
        {opp.scoutUnit.unitName ? ` — ${opp.scoutUnit.unitName}` : ""}
      </h3>
      <p className="text-xs text-muted-foreground">
        {formatSpeciesName(opp.scoutUnit.speciesId)} · {opp.scoutUnit.pointsRequiredNonresident === 0 ? "OTC" : "High-odds draw"} · {Math.round(opp.scoutUnit.successRate * 100)}% success
      </p>

      {/* Strategic connection */}
      <p className="text-sm text-muted-foreground mt-2">
        {opp.strategicReason}
      </p>

      {/* Target unit reference */}
      <div className="mt-2 flex items-center gap-1 text-xs text-violet-400/80">
        <Target className="w-3 h-3" />
        <span>
          Scouting for {targetState?.abbreviation ?? opp.targetUnit.stateId} Unit {opp.targetUnit.unitCode} ({opp.targetYearsAway}yr build)
        </span>
      </div>

      {/* Score pills */}
      <div className="flex flex-wrap gap-1 mt-2">
        {opp.terrainOverlap.length > 0 && (
          <span className="text-[10px] px-1.5 py-0.5 rounded bg-violet-500/10 text-violet-300">
            {opp.terrainOverlap.join(" · ")}
          </span>
        )}
        <span className="text-[10px] px-1.5 py-0.5 rounded bg-violet-500/10 text-violet-300">
          Score: {opp.totalScore}/100
        </span>
      </div>
    </div>
  );
});
```

In the main `StatePortfolio` component:
- After the state cards section (after the `AlsoConsidered` section if it exists, or after the main state cards mapping), add a scouting section:
- Compute scouting opportunities: `const scoutingOpps = useMemo(() => detectScoutingOpportunities(assessment), [assessment]);`
- Render conditionally:
```tsx
{scoutingOpps.length > 0 && (
  <div className="mt-6 space-y-3">
    <div className="flex items-center gap-2">
      <Binoculars className="w-4 h-4 text-violet-400" />
      <h3 className="text-sm font-semibold text-violet-400 uppercase tracking-wider">
        Scouting Opportunities
      </h3>
    </div>
    <div className="grid gap-3 sm:grid-cols-2">
      {scoutingOpps.map((opp) => (
        <ScoutingMoveCard key={`${opp.scoutUnitId}-${opp.targetUnit.unitCode}`} opp={opp} />
      ))}
    </div>
  </div>
)}
```

Import `useMemo` if not already imported, and `Target` from lucide-react if not already imported.

**CalendarSlot.tsx -- Add scouting hunt badge:**

1. Modify the CalendarSlot component to detect scouting hunt items and render a distinct badge.
2. Check if `slot.scoutingTarget` exists (this field is now on CalendarSlotData).
3. When `slot.scoutingTarget` is present:
   - Override the urgency color classes with violet: use `"border-violet-500/30 bg-violet-500/5"` instead of the standard urgency classes
   - Add a "SCOUT HUNT" badge in the tag type area (alongside or replacing the existing tag badge):
     ```tsx
     {slot.scoutingTarget && (
       <span className="text-[7px] px-1 rounded uppercase font-medium leading-tight bg-violet-500/15 text-violet-400">
         SCOUT HUNT
       </span>
     )}
     ```
   - Update the title attribute to include the scouting context: `slot.scoutingTarget ? \`Scouting for ${slot.scoutingTarget.targetStateId} Unit ${slot.scoutingTarget.targetUnitCode}: ${slot.scoutingTarget.strategicReason}\` : (slot.advisorNote || slot.description)`

4. Import `ScoutingTarget` type is NOT needed since it's already on CalendarSlotData (inherited from the type).

Note: The actual population of `scoutingTarget` on calendar slots for scouting-move hunts will happen when scouting hunts are injected into the roadmap/calendar. For now, the rendering logic is ready. The scouting engine outputs ScoutingOpportunity[], which the calendar enrichment layer can convert to calendar slots with scoutingTarget metadata. The simplest approach: in the StatePortfolio component (where scouting is computed), when the user has scouting opportunities, the calendar grid can be enriched post-build. However, the primary visual delivery is through the ScoutingMoveCard section in StatePortfolio and the advisor insights -- the calendar badge is a secondary enhancement that activates when a scouting hunt is present in the roadmap actions with a "scout" type that has scoutingTarget.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- no type errors. Run `npm run build` to verify the full build succeeds (catches SSR issues, dynamic imports, etc.). Visually: the StatePortfolio section should show ScoutingMoveCards with violet accent when scouting opportunities exist.
  </verify>
  <done>
    ScoutingMoveCard renders in the States tab with violet accent, Binoculars icon, strategic connection text, and score pills. CalendarSlot renders a "SCOUT HUNT" badge with violet styling when scoutingTarget is present. The entire scouting feature is wired end-to-end: engine detects opportunities, advisor explains them, calendar distinguishes them visually, and results present them as actionable cards.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (no SSR/dynamic import issues)
3. Advisor pipeline produces scouting insights for assessments with trophy targets
4. CalendarSlot renders violet "SCOUT HUNT" badge when scoutingTarget is present
5. StatePortfolio shows ScoutingMoveCard section below state cards (only when scouting opportunities exist)
6. No scouting UI appears for all-OTC portfolios
</verification>

<success_criteria>
- Advisor pipeline has 8 sub-generators (7 existing + scouting)
- ScoutingMoveCard displays in results with violet accent and strategic connection
- CalendarSlot distinguishes scouting hunts from regular scout items
- All new code compiles and builds cleanly
- Feature degrades gracefully: no scouting section when no opportunities detected
</success_criteria>

<output>
After completion, create `.planning/phases/10-scouting-strategy/10-02-SUMMARY.md`
</output>
