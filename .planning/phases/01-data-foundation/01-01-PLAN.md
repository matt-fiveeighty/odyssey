---
phase: 01-data-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/verified-datum.ts
  - src/lib/engine/verified-datum.test.ts
autonomous: true

must_haves:
  truths:
    - "verified() wraps a raw value with source URL, scrape date, label, and 'verified' confidence"
    - "estimated() wraps a value with 'estimated' confidence and a basis string as the source label"
    - "userReported() wraps a value with 'user_reported' confidence and a reported-at date"
    - "unwrap() extracts the raw value from any VerifiedDatum without loss"
    - "verifyBatch() wraps an array of values sharing the same source into VerifiedDatum[]"
    - "deriveConfidence() returns the lowest confidence from multiple VerifiedDatum inputs"
    - "staleDays is computed from scrapedAt and isStale is true when staleDays exceeds a configurable threshold"
  artifacts:
    - path: "src/lib/engine/verified-datum.ts"
      provides: "VerifiedDatum<T> type, DataConfidence type, factory functions, unwrap, verifyBatch, deriveConfidence"
      exports: ["DataConfidence", "VerifiedDatum", "verified", "estimated", "userReported", "unwrap", "verifyBatch", "deriveConfidence", "STALE_THRESHOLDS"]
    - path: "src/lib/engine/verified-datum.test.ts"
      provides: "Test coverage for all VerifiedDatum functions"
      contains: "describe.*VerifiedDatum"
  key_links:
    - from: "src/lib/engine/verified-datum.ts"
      to: "src/lib/types/index.ts"
      via: "DataConfidence type is standalone (no dependency on existing types)"
      pattern: "export type DataConfidence"
---

<objective>
Create the VerifiedDatum<T> type system with factory functions, unwrap helpers, and confidence propagation -- the provenance primitive that every downstream feature depends on.

Purpose: DATA-01 (provenance metadata), DATA-05 (unwrap helper), DATA-06 (derived confidence inheritance) form the foundation for trustworthy data display. Without this, freshness badges, advisor voice confidence, and three-tier resolution have nothing to attach to.

Output: `src/lib/engine/verified-datum.ts` with full test coverage in `src/lib/engine/verified-datum.test.ts`
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/types/index.ts
@src/lib/engine/data-loader.ts
</context>

<feature>
  <name>VerifiedDatum type system and provenance helpers</name>
  <files>src/lib/engine/verified-datum.ts, src/lib/engine/verified-datum.test.ts</files>
  <behavior>
    VerifiedDatum&lt;T&gt; wraps any value T with provenance metadata: source (url, scrapedAt, label), confidence level, staleness tracking.

    Type definitions:
    - DataConfidence = "verified" | "estimated" | "stale" | "user_reported"
    - VerifiedDatum&lt;T&gt; = { value: T, source: { url, scrapedAt, label }, confidence: DataConfidence, staleDays: number | null, isStale: boolean }

    Stale thresholds (exported as STALE_THRESHOLDS):
    - Default: 10 days (aligned with existing STALE_THRESHOLD_DAYS in data-loader.ts)
    - flight_prices: 1 day
    - cpi_data: 45 days
    - deadlines: 30 days

    Factory functions:
    - verified(value, sourceUrl, scrapedAt, label) -> VerifiedDatum with confidence "verified", staleDays computed from scrapedAt vs now
    - estimated(value, basis) -> VerifiedDatum with confidence "estimated", source.url = "", source.label = basis, staleDays = null
    - userReported(value, reportedAt) -> VerifiedDatum with confidence "user_reported", source.url = "", source.scrapedAt = reportedAt

    Helpers:
    - unwrap(datum) -> datum.value (extracts raw value)
    - verifyBatch(items, sourceUrl, scrapedAt, label) -> items.map(item => verified(item, sourceUrl, scrapedAt, label))
    - deriveConfidence(...datums) -> lowest confidence level among inputs, using ordering: verified > user_reported > estimated > stale

    Test cases:
    - verified(42, "https://cpw.state.co.us", "2026-02-15", "CPW") -> { value: 42, confidence: "verified", source.url: "https://cpw.state.co.us", staleDays: ~6 }
    - estimated(0.03, "Historical 10-year CPI average") -> { value: 0.03, confidence: "estimated", source.label: "Historical 10-year CPI average" }
    - userReported(5, "2026-01-10") -> { value: 5, confidence: "user_reported" }
    - unwrap(verified(42, ...)) -> 42
    - unwrap(estimated("hello", ...)) -> "hello"
    - verifyBatch([1,2,3], url, date, label) -> 3 VerifiedDatum objects each with same source
    - deriveConfidence(verified(...), estimated(...)) -> "estimated" (lowest wins)
    - deriveConfidence(verified(...), userReported(...)) -> "user_reported"
    - deriveConfidence(verified(...), verified(...)) -> "verified"
    - verified() with scrapedAt 15 days ago and default threshold -> isStale = true, staleDays = 15
    - verified() with scrapedAt 3 days ago -> isStale = false, staleDays = 3
    - estimated() -> isStale = false (estimated data has no scrape date to go stale)
  </behavior>
  <implementation>
    1. Create src/lib/engine/verified-datum.ts with:
       - DataConfidence type union
       - VerifiedDatum&lt;T&gt; interface
       - CONFIDENCE_ORDER constant: { verified: 0, user_reported: 1, estimated: 2, stale: 3 }
       - STALE_THRESHOLDS constant object with default and category-specific thresholds
       - computeStaleDays(scrapedAt: string): number — diff in days between scrapedAt and Date.now()
       - verified&lt;T&gt;() factory — computes staleDays, sets isStale based on default threshold
       - estimated&lt;T&gt;() factory — staleDays = null, isStale = false
       - userReported&lt;T&gt;() factory — staleDays computed from reportedAt, isStale = false (user data doesn't go "stale")
       - unwrap&lt;T&gt;(datum: VerifiedDatum&lt;T&gt;): T — returns datum.value
       - verifyBatch&lt;T&gt;() — maps over array calling verified() for each
       - deriveConfidence(...datums: VerifiedDatum&lt;unknown&gt;[]): DataConfidence — finds max CONFIDENCE_ORDER value among inputs

    2. Use Vitest for tests (check if vitest is in devDependencies; if not, use Jest patterns matching existing test setup). Test file at src/lib/engine/verified-datum.test.ts.

    IMPORTANT: Do NOT import from or modify src/lib/types/index.ts. VerifiedDatum is a standalone module in the engine directory. Future phases will gradually integrate it with existing types.
  </implementation>
</feature>

<verification>
- `npx vitest run src/lib/engine/verified-datum.test.ts` passes (or equivalent test runner)
- `npx tsc --noEmit` passes (no type errors)
- All test cases from behavior section pass
</verification>

<success_criteria>
- VerifiedDatum&lt;T&gt; type exported and usable with any value type (number, string, object)
- All 5 factory/helper functions exported and tested
- deriveConfidence correctly returns lowest confidence from mixed inputs
- Staleness computation works correctly with real date math
- Zero dependencies on existing app types (standalone module)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
