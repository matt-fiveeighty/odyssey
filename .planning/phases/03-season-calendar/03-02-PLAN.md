---
phase: 03-season-calendar
plan: 02
type: execute
wave: 2
depends_on: [1]
files_modified:
  - src/components/results/sections/CalendarSlot.tsx
  - src/components/results/sections/SeasonCalendar.tsx
  - src/components/results/sections/TimelineRoadmap.tsx
autonomous: false

must_haves:
  truths:
    - "User sees a month-by-month swimlane calendar with state rows and 12 month columns when clicking the month-view toggle in the Timeline tab"
    - "Each calendar slot shows species avatar, state abbreviation, tag type badge, purpose label, and estimated cost"
    - "Empty months display a subtle dot indicator making open slots visually distinct from populated months"
    - "Calendar items are color-coded by urgency -- red border/text for <=14 days, amber for <=30, green for >30"
    - "A summary row at the bottom shows monthly cost totals across all states"
    - "Year selector arrows let the user navigate between roadmap years"
    - "On mobile (below md breakpoint), the calendar renders as a vertical month list instead of the 13-column grid"
    - "The existing year-accordion view in TimelineRoadmap is unchanged and remains the default view"
  artifacts:
    - path: "src/components/results/sections/CalendarSlot.tsx"
      provides: "Individual calendar slot chip component"
      exports: ["CalendarSlot"]
    - path: "src/components/results/sections/SeasonCalendar.tsx"
      provides: "Swimlane calendar container with state rows x month columns"
      exports: ["SeasonCalendar"]
    - path: "src/components/results/sections/TimelineRoadmap.tsx"
      provides: "Modified timeline with year/month zoom toggle"
      exports: ["TimelineRoadmap"]
  key_links:
    - from: "src/components/results/sections/SeasonCalendar.tsx"
      to: "src/lib/engine/calendar-grid.ts"
      via: "calls buildCalendarGrid(assessment, selectedYear)"
      pattern: "buildCalendarGrid"
    - from: "src/components/results/sections/SeasonCalendar.tsx"
      to: "src/components/results/sections/CalendarSlot.tsx"
      via: "renders CalendarSlot for each slot in month cells"
      pattern: "import.*CalendarSlot"
    - from: "src/components/results/sections/CalendarSlot.tsx"
      to: "src/lib/engine/urgency.ts"
      via: "uses urgencyColorClass for slot border/text coloring"
      pattern: "import.*urgencyColorClass.*from.*urgency"
    - from: "src/components/results/sections/TimelineRoadmap.tsx"
      to: "src/components/results/sections/SeasonCalendar.tsx"
      via: "renders SeasonCalendar when viewMode is 'months'"
      pattern: "import.*SeasonCalendar"
---

<objective>
Build the SeasonCalendar swimlane UI, CalendarSlot chip component, and integrate them into TimelineRoadmap as a month-view zoom level -- delivering the complete calendar experience (CAL-01 through CAL-08).

Purpose: This is the user-visible deliverable of Phase 3. The data model from Plan 01 gets a visual representation: state rows by month columns, color-coded urgency, cost summaries, and responsive mobile layout.

Output: Three component files (CalendarSlot, SeasonCalendar, modified TimelineRoadmap) that together deliver the full season calendar feature inside the existing Timeline tab.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-season-calendar/03-RESEARCH.md
@.planning/phases/03-season-calendar/03-01-SUMMARY.md

@src/lib/types/index.ts
@src/lib/engine/urgency.ts
@src/lib/engine/calendar-grid.ts
@src/components/results/sections/TimelineRoadmap.tsx
@src/components/results/ResultsShell.tsx
@src/components/shared/SpeciesAvatar.tsx
@src/lib/constants/state-images.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CalendarSlot chip component</name>
  <files>src/components/results/sections/CalendarSlot.tsx</files>
  <action>
Create `src/components/results/sections/CalendarSlot.tsx` as a client component that renders a single calendar item as a compact chip inside a month cell.

**Props:**
```typescript
interface CalendarSlotProps {
  slot: CalendarSlotData;  // From calendar-grid.ts
}
```

**Visual structure (compact chip, ~28-32px tall):**

The chip is a small rounded container with a left color-accent border (2px) using urgency color. Inside, a single row with:
1. `SpeciesAvatar` at size 16 (tiny thumbnail)
2. A text area with:
   - Top line: species name via `formatSpeciesName(slot.speciesId)` truncated, text-[9px] font-medium
   - Bottom line: tag type badge + cost, text-[8px] text-muted-foreground
3. If `slot.dueDate` exists, show day number (e.g., "15th") in text-[8px] on the right edge

**Tag type badge:** A tiny inline badge (text-[7px] px-1 rounded uppercase):
- `"draw"`: `bg-info/15 text-info` label "DRAW"
- `"otc"`: `bg-chart-2/15 text-chart-2` label "OTC"
- `"leftover"`: `bg-chart-4/15 text-chart-4` label "LEFT"
- `"points_only"`: `bg-warning/15 text-warning` label "PTS"
- `"n/a"`: no badge shown

**Urgency coloring:** Import `urgencyColorClass` from `@/lib/engine/urgency`. Apply the returned classes to the chip's left border (via `border-l-2` + the border color from urgencyColorClass). For the background, use a very subtle tint: extract just the bg class from urgencyColorClass.

**Item type icon:** Use a tiny (w-2.5 h-2.5) lucide icon before the species name to indicate purpose:
- `"application"`: FileText
- `"point_purchase"`: Coins
- `"hunt"`: Target
- `"scout"`: Binoculars
- `"deadline"`: AlertCircle
- `"prep"`: Wrench

**Overflow handling:** The chip should have `overflow-hidden` and `text-ellipsis` on text content. In a crowded cell (4+ items), chips stack vertically with `gap-0.5`.

**Imports:** SpeciesAvatar from `@/components/shared/SpeciesAvatar`, formatSpeciesName from `@/lib/utils`, urgencyColorClass from `@/lib/engine/urgency`, CalendarSlotData from `@/lib/engine/calendar-grid`, lucide-react icons.

Do NOT make the chip interactive (no onClick, no expand). Clicking to expand is a future enhancement. Keep it display-only for Phase 3.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the file exports CalendarSlot. Verify it imports from urgency.ts and calendar-grid.ts.
  </verify>
  <done>CalendarSlot renders a compact chip showing species avatar, purpose icon, species name, tag type badge, cost, and urgency color-coding -- all within ~30px height for grid cell density.</done>
</task>

<task type="auto">
  <name>Task 2: SeasonCalendar swimlane container and TimelineRoadmap integration</name>
  <files>
    src/components/results/sections/SeasonCalendar.tsx
    src/components/results/sections/TimelineRoadmap.tsx
  </files>
  <action>
**Part A: Create `src/components/results/sections/SeasonCalendar.tsx`**

A client component that renders the full swimlane calendar grid.

**Props:**
```typescript
interface SeasonCalendarProps {
  assessment: StrategicAssessment;
}
```

**State:**
- `selectedYear: number` -- defaults to current calendar year if within `availableYears`, else first available year. Use `useMemo` to compute the initial value.

**Data flow:** Call `buildCalendarGrid(assessment, selectedYear)` in a `useMemo` that depends on `[assessment, selectedYear]`. This returns the `CalendarGrid`.

**Desktop layout (md and above):** CSS Grid with `grid-cols-[100px_repeat(12,1fr)]`:

Row 0 -- **Month headers**: Empty corner cell + 12 month labels (Jan-Dec). Style: `text-[9px] font-medium text-muted-foreground uppercase tracking-wider text-center`. Highlight the current month with `text-foreground font-bold` if the selected year is the current year.

Rows 1-N -- **State rows**: For each `CalendarRow` in `grid.rows`:
- Left cell: State badge (colored square with abbreviation using `state.color` as background, white text, text-[8px] font-bold rounded) + state name truncated in text-[10px].
- 12 month cells: For each month 1-12:
  - Get `row.months.get(month) ?? []`
  - If empty (CAL-05): render a subtle empty indicator -- a small dot (`w-1.5 h-1.5 rounded-full bg-border/40`) centered in the cell, with `bg-secondary/5` background to distinguish from populated cells.
  - If populated: render `<CalendarSlot>` for each slot, stacked vertically with `gap-0.5`. If count > 3, show first 2 slots + a "+N more" badge in text-[8px] text-muted-foreground.
  - Cell min-height: `min-h-[52px]` for visual consistency.

Last row -- **Summary row (CAL-07)**: Left cell shows "Monthly Total" in text-[9px] font-bold. 12 cost cells show `grid.monthlyCosts[i]` formatted as `$X,XXX` or `--` if zero. Use `font-mono text-[9px]`. Bold the highest-cost month. At the far right of the summary row, show `grid.totalCost` as an annual total.

**Year selector (above the grid):**
A row with: left-chevron button, year display (bold, text-sm), right-chevron button. Buttons navigate between `grid.availableYears`. Disable left at first year, right at last year. Also show the year's phase label from `assessment.roadmap.find(r => r.year === selectedYear)?.phase` as a small badge (using the same PHASE_COLORS mapping from TimelineRoadmap.tsx).

**Mobile layout (below md):**
Instead of the grid, render a vertical list grouped by month (matching the pattern from MilestoneCalendar.tsx):
- For each month (1-12), if there are any slots across all rows:
  - Month heading: "January 2026" style, text-xs font-bold
  - Under it, list all CalendarSlotData for that month across all states, each rendered as a `<CalendarSlot>` with the state abbreviation prepended.
- Skip months with zero items across all states.
- Show a monthly cost total below each month's items.

**Grid styling:** Use `gap-px bg-border/20 rounded-xl overflow-hidden` on the grid container so the 1px gaps create subtle grid lines between cells. Each cell gets `bg-background` to sit on top of the gap color.

**Imports:** buildCalendarGrid, CalendarGrid from calendar-grid.ts, CalendarSlot from CalendarSlot.tsx, StrategicAssessment from types, ChevronLeft/ChevronRight from lucide-react, STATE_VISUALS from state-images.ts (for gradient backgrounds on state badges).

---

**Part B: Modify `src/components/results/sections/TimelineRoadmap.tsx`**

Add a `viewMode` toggle that switches between the existing year-accordion view and the new month-swimlane view (CAL-08).

Changes:

1. **New state:** `const [viewMode, setViewMode] = useState<"years" | "months">("years");`

2. **Toggle button in header:** Add a toggle to the existing header area (the row with "10-Year Roadmap" text and total cost). Place it between the title and the cost. Two icon buttons:
   - `List` icon (from lucide-react) for "years" view -- the existing accordion
   - `CalendarDays` icon (from lucide-react) for "months" view -- the new swimlane
   Style: `p-1.5 rounded-lg` with `bg-primary/10 text-primary` when active, `text-muted-foreground hover:text-foreground` when inactive. Small (w-7 h-7).

3. **Conditional rendering:** Below the visual timeline bar (keep the timeline bar visible in both modes -- it provides context):
   - If `viewMode === "years"`: render the existing year accordion (key years callout + year cards) unchanged.
   - If `viewMode === "months"`: render `<SeasonCalendar assessment={assessment} />`.

4. **Import SeasonCalendar:** Add `import { SeasonCalendar } from "./SeasonCalendar";` -- NOT dynamic import. The SeasonCalendar is already inside the dynamically-loaded TimelineRoadmap, so it does not need its own code split.

5. **Preserve all existing functionality:** The year accordion, editing, add/remove actions, year cost calculations -- ALL remain unchanged. The viewMode toggle simply controls which view is rendered below the timeline bar. When in "months" mode, the editedActions, editingYear, and related editing state are irrelevant (the calendar is read-only).

Do NOT:
- Remove or modify any existing year accordion code
- Change the TimelineRoadmapProps interface
- Add new props -- SeasonCalendar reads assessment from the prop already passed to TimelineRoadmap
- Create a new tab in ResultsShell -- the calendar is a zoom level INSIDE the Timeline tab (CAL-08)
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to ensure no build errors (dynamic imports and new components resolve correctly). Verify:
- `grep "export function SeasonCalendar" src/components/results/sections/SeasonCalendar.tsx` confirms component exists
- `grep "import.*SeasonCalendar" src/components/results/sections/TimelineRoadmap.tsx` confirms integration
- `grep "viewMode" src/components/results/sections/TimelineRoadmap.tsx` confirms toggle state
- `grep "buildCalendarGrid" src/components/results/sections/SeasonCalendar.tsx` confirms data flow
- `grep "CalendarSlot" src/components/results/sections/SeasonCalendar.tsx` confirms slot rendering
- `grep "monthlyCosts" src/components/results/sections/SeasonCalendar.tsx` confirms summary row
  </verify>
  <done>SeasonCalendar renders a responsive swimlane grid (desktop: CSS grid with state rows x month columns; mobile: vertical month list) with urgency coloring, empty month indicators, monthly cost totals, and year navigation. TimelineRoadmap provides a years/months toggle that switches between the existing accordion and the new calendar -- no existing functionality broken.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of season calendar</name>
  <files>src/components/results/sections/SeasonCalendar.tsx</files>
  <action>
Verify the complete season calendar feature visually in the browser. The executor should have the dev server running. This checkpoint confirms the calendar renders correctly, the toggle works, urgency colors display properly, empty months are distinguishable, and the mobile layout degrades gracefully.
  </action>
  <verify>
Follow the how-to-verify steps below to confirm all visual and functional aspects of the calendar.
  </verify>
  <done>User has visually confirmed the season calendar renders correctly in the Timeline tab with all required features: swimlane grid, slot chips, urgency colors, empty month indicators, cost summary row, year navigation, and mobile layout.</done>
  <what-built>Complete season calendar feature: urgency utility, calendar data model, CalendarSlot chips, SeasonCalendar swimlane, and TimelineRoadmap zoom toggle. The calendar renders inside the existing Timeline tab.</what-built>
  <how-to-verify>
1. Navigate to the app and complete (or load) a consultation to see results
2. Click the "Timeline" tab
3. Verify the existing year accordion still works (default view)
4. Click the calendar/month icon in the header area to switch to month view
5. Verify the swimlane grid appears with:
   - State rows on the left with colored badges
   - 12 month columns (Jan-Dec)
   - Calendar slot chips showing species, tag type, cost
   - Urgency color-coding on slot borders (if any deadlines are within 30 days)
   - Empty months showing subtle dot indicators
   - Summary row at bottom with monthly cost totals
6. Use the year selector arrows to navigate between roadmap years
7. Click the list icon to switch back to year accordion view -- verify it still works correctly with editing
8. Resize browser to mobile width (below 768px) -- verify the calendar switches to a vertical month list
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<technical_notes>
- The PHASE_COLORS mapping from TimelineRoadmap.tsx should be reused in SeasonCalendar for the year badge. Either import it (if extracted) or duplicate the small object -- it is only 4 entries.
- The `+N more` overflow handling for crowded cells (>3 items) prevents the grid from becoming unreadable with 5-species states. Research Pitfall 1 specifically warns about this.
- The CSS Grid gap-px technique creates visible grid lines without explicit border styles -- just bg-border/20 on the container and bg-background on each cell.
- The current month highlighting in headers uses `new Date().getMonth()` compared to the month index -- only highlight when selectedYear is the current year.
- Responsive breakpoint at `md` (768px) matches the app's existing responsive patterns in ResultsShell.
- The timeline bar (visual year strip at top of TimelineRoadmap) stays visible in both modes because it provides year context and allows quick year expansion/selection.
</technical_notes>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds
- TimelineRoadmap has viewMode toggle between "years" and "months"
- SeasonCalendar renders when viewMode is "months"
- CalendarSlot shows species, tag type, cost, urgency colors
- Empty months show dot indicators (CAL-05)
- Summary row shows monthly cost totals (CAL-07)
- Year selector navigates between available years
- Mobile renders vertical list instead of grid
- Existing year accordion functionality (expand, edit, add/remove) is unchanged
</verification>

<success_criteria>
1. Swimlane calendar shows state rows x month columns with all hunt activities for the selected year (CAL-01, CAL-02, CAL-03)
2. Each slot displays species, tag type, purpose, and estimated cost (CAL-04)
3. Empty months are visually distinct with dot indicators (CAL-05)
4. Slots are color-coded by urgency: red <=14d, amber <=30d, green >30d (CAL-06)
5. Summary row shows monthly cost totals (CAL-07)
6. Calendar lives as a zoom level inside the Timeline tab via toggle (CAL-08)
7. Mobile layout degrades gracefully to vertical month list
8. Existing TimelineRoadmap year accordion is completely unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-season-calendar/03-02-SUMMARY.md`
</output>
