---
phase: 05-advisor-voice
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/engine/advisor.ts
  - src/lib/engine/advisor-creep.ts
autonomous: true

must_haves:
  truths:
    - "generateAdvisorInsights() consumes BoardState, PortfolioHealthResult, StrategyMetrics, DisciplineViolation[], Milestone[], UserPoints[], TemporalContext, and StrategicAssessment and returns AdvisorInsight[]"
    - "Deadline insights use urgency thresholds from urgency.ts (red<=14d, amber<=30d, green>30d) and produce urgency-calibrated commentary"
    - "Portfolio insights reference the user's specific states, species, points, and budget -- not generic text"
    - "Discipline insights translate violation observation+implication+recommendation into advisor voice with CTAs"
    - "Point creep shift detection compares assessment drawConfidence against current yearsToDrawWithCreep projections"
    - "Creep shift insights state specific impact like 'CO elk moved from Year 5 to Year 6'"
    - "Insights are sorted by urgency priority (immediate > soon > informational > positive) and capped at 7"
    - "Every insight has a non-empty cta with valid href"
    - "Temporal context only appears when isReturningUser is true and daysSinceLastVisit >= 1"
    - "Advisor never suggests abandoning the user's plan (ADV-08)"
  artifacts:
    - path: "src/lib/engine/advisor.ts"
      provides: "generateAdvisorInsights main pipeline, sub-generators for deadline/portfolio/discipline/temporal/milestone insights"
      exports: ["generateAdvisorInsights"]
    - path: "src/lib/engine/advisor-creep.ts"
      provides: "Point creep shift detection and CreepShiftResult type"
      exports: ["generatePointCreepInsights", "CreepShiftResult"]
  key_links:
    - from: "src/lib/engine/advisor.ts"
      to: "src/lib/engine/urgency.ts"
      via: "uses getUrgencyLevel and daysUntilDate for deadline insights"
      pattern: "getUrgencyLevel|daysUntilDate"
    - from: "src/lib/engine/advisor.ts"
      to: "src/lib/engine/advisor-temporal.ts"
      via: "uses TemporalContext and formatTemporalPrefix"
      pattern: "TemporalContext|formatTemporalPrefix"
    - from: "src/lib/engine/advisor-creep.ts"
      to: "src/lib/engine/point-creep.ts"
      via: "uses yearsToDrawWithCreep and estimateCreepRate"
      pattern: "yearsToDrawWithCreep|estimateCreepRate"
    - from: "src/lib/engine/advisor.ts"
      to: "src/lib/engine/advisor-creep.ts"
      via: "imports generatePointCreepInsights into pipeline"
      pattern: "generatePointCreepInsights"
---

<objective>
Build the advisor insight generator engine -- the pure-function pipeline that transforms raw board state, health, metrics, violations, milestones, points, and temporal context into prioritized, portfolio-specific AdvisorInsight[] items with actionable CTAs.

Purpose: This is the brain of Phase 5. Requirements ADV-02 through ADV-08 all depend on this engine producing the right insights. Dashboard and calendar UI plans consume its output.

Output: Two new engine modules: advisor.ts (main pipeline + 5 sub-generators) and advisor-creep.ts (point creep shift detection).
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advisor-voice/05-RESEARCH.md
@.planning/phases/05-advisor-voice/05-01-SUMMARY.md
@src/lib/types/index.ts
@src/lib/engine/urgency.ts
@src/lib/engine/point-creep.ts
@src/lib/engine/portfolio-health.ts
@src/lib/engine/board-state.ts
@src/lib/engine/strategy-metrics.ts
@src/lib/engine/discipline-rules.ts
@src/lib/engine/advisor-temporal.ts
@src/lib/constants/states.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Point creep shift detection engine (advisor-creep.ts)</name>
  <files>src/lib/engine/advisor-creep.ts</files>
  <action>
Create `src/lib/engine/advisor-creep.ts` with:

1. `CreepShiftResult` interface:
   - `stateId: string`
   - `speciesId: string`
   - `unitCode: string`
   - `previousDrawYear: number` (from assessment's drawConfidence.expected)
   - `currentDrawYear: number` (recomputed with current points)
   - `shiftYears: number` (currentDrawYear - previousDrawYear, positive = worse)
   - `creepRate: number`

2. `detectCreepShifts` pure function:
   ```typescript
   export function detectCreepShifts(
     assessment: StrategicAssessment,
     userPoints: UserPoints[],
   ): CreepShiftResult[]
   ```
   For each `stateRecommendation` in the assessment, for each `bestUnit` that has `drawConfidence`:
   - Get the unit's `drawConfidence.expected` as `previousDrawYear`
   - Find the user's current points for that state+species in `userPoints` (default 0)
   - Get the unit's `pointsRequiredNonresident` from the Units data, or estimate from drawConfidence
   - Use `estimateCreepRate(trophyRating)` from point-creep.ts for the creep rate
   - Compute `currentDrawYear = yearsToDrawWithCreep(currentUserPoints, pointsRequired, creepRate)`
   - If `currentDrawYear !== previousDrawYear`, add to results
   - Only include shifts where `shiftYears > 0` (creep made things worse) -- ignore improvements

3. `generatePointCreepInsights` function:
   ```typescript
   export function generatePointCreepInsights(
     assessment: StrategicAssessment,
     userPoints: UserPoints[],
   ): AdvisorInsight[]
   ```
   Calls `detectCreepShifts`, then for each shift result:
   - `id`: `"creep-${stateId}-${speciesId}"`
   - `signal`: `{ type: "warning", message: "Draw timeline shifted for ${state} ${species}" }`
   - `category`: `"point_creep"`
   - `urgency`: `shiftYears >= 2 ? "immediate" : "soon"`
   - `interpretation`: `"${STATE} ${species} draw moved from Year ${prev} to Year ${curr}. Point creep is eroding your position at ${rate} pts/yr."` (using STATES_MAP for state abbreviation, formatSpeciesName for species)
   - `recommendation`: `"Consider applying this cycle to lock in your current position, or increase point purchases to stay ahead of creep."` (per ADV-08: never suggest abandoning the plan)
   - `cta`: `{ label: "Review Draw Timeline", href: "/plan-builder" }` (link to plan builder where they can see their roadmap)
   - `portfolioContext`: `"You have ${pts} ${state} ${species} points"` using user's actual point count

Import `yearsToDrawWithCreep`, `estimateCreepRate` from `point-creep.ts`. Import `STATES_MAP` from constants/states. Import `formatSpeciesName` from utils. Import `AdvisorInsight` from types.

Handle edge cases:
- If `drawConfidence` is missing on a unit, skip it (graceful fallback per Research Pitfall 5)
- If userPoints has no entry for that state+species, use 0 points
- Cap results at 3 most severe shifts (sorted by shiftYears descending)
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation.</verify>
  <done>advisor-creep.ts exports CreepShiftResult, detectCreepShifts, and generatePointCreepInsights. Handles missing drawConfidence gracefully. Caps at 3 results.</done>
</task>

<task type="auto">
  <name>Task 2: Main advisor insight generator pipeline (advisor.ts)</name>
  <files>src/lib/engine/advisor.ts</files>
  <action>
Create `src/lib/engine/advisor.ts` with:

**Constants:**
- `MAX_VISIBLE_INSIGHTS = 7`

**Sub-generators (all return AdvisorInsight[]):**

1. `generateDeadlineInsights(milestones, assessment)`:
   For each milestone in the current year (or milestone with a dueDate in the future) that has a `dueDate`:
   - Use `daysUntilDate(dueDate)` from urgency.ts
   - Use `getUrgencyLevel(dueDate)` to determine urgency mapping:
     - "red" (<=14d) -> AdvisorUrgency "immediate"
     - "amber" (<=30d) -> "soon"
     - "green" (>30d) -> "informational"
     - "overdue"/"none" -> skip (don't generate insight for overdue or undated)
   - `interpretation` varies by urgency:
     - immediate: "${state} ${species} closes in ${days} days. Miss this and you lose a year of point building."
     - soon: "${state} ${species} deadline is ${days} days out. Time to finalize your unit choices."
     - informational: "${state} ${species} opens in ~${days} days. No rush, but start thinking about your approach."
   - `recommendation`:
     - immediate: "Submit your application today. Cost: $${cost}."
     - soon: "Review your unit selections and budget, then apply before the deadline."
     - informational: "Use this time to research units and confirm your strategy."
   - `cta`:
     - If milestone has a URL and urgency is immediate/soon: `{ label: "Apply Now", href: url, external: true }`
     - Else: `{ label: "View Deadlines", href: "/deadlines" }`
   - `portfolioContext`: Include user's point count for that state+species from the assessment if available
   - Cap at 3 deadline insights (nearest first)

2. `generatePortfolioInsights(boardState, health, metrics, assessment)`:
   Generate 1-2 insights based on portfolio health score:
   - If health.score < 60: urgency "soon", interpretation explains which dimension is weakest (find min in breakdown), recommendation specific to that dimension
   - If health.score >= 80: urgency "positive", interpretation celebrates strong position, recommendation to maintain course
   - If health.score 60-79: urgency "informational", interpretation notes the score and weakest area
   - Always include `portfolioContext` with the user's state count, species count, and annual spend from metrics
   - `cta`: `{ label: "View Strategy", href: "/plan-builder" }`
   - If `metrics.portfolioConcentrationPercentage > 70`: add second insight about concentration risk
   - Cap at 2 portfolio insights

3. `generateDisciplineInsights(violations)`:
   For each DisciplineViolation:
   - Map severity to urgency: "critical" -> "immediate", "warning" -> "soon", "info" -> "informational"
   - `interpretation`: Use the violation's `observation` field
   - `recommendation`: Use the violation's `recommendation` field
   - `cta`:
     - budget_concentration/premium_overload: `{ label: "Review Allocation", href: "/plan-builder" }`
     - build_fatigue/cadence_below_target: `{ label: "Add Opportunity Hunt", href: "/plan-builder" }`
     - plateau_detected/point_abandonment: `{ label: "Review Points", href: "/points" }`
     - strategic_drift: `{ label: "Update Strategy", href: "/plan-builder" }`
   - `portfolioContext`: Use violation's `affectedStates` to list affected states
   - Cap at 2 discipline insights (critical first)

4. `generateTemporalInsights(temporal, milestones)`:
   Only generate if `temporal.isReturningUser && temporal.daysSinceLastVisit >= 1`.
   - Count milestones with deadlines that passed since last visit but are still upcoming
   - Count milestones that became urgent since last visit (were green, now amber/red)
   - If any urgency changes: generate insight about what changed
   - If long absence (>30 days): generate "welcome back" insight summarizing plan year
   - Use `formatTemporalPrefix(temporal)` for temporalContext field
   - Cap at 1 temporal insight (avoid noise)

5. `generateMilestoneInsights(milestones)`:
   Generate insights about milestone completion progress:
   - If pending milestones exist: count completed vs total, mention next pending
   - If all milestones complete for current year: positive insight
   - Cap at 1 milestone insight

**Main pipeline:**

```typescript
export function generateAdvisorInsights(
  boardState: BoardState,
  health: PortfolioHealthResult,
  metrics: StrategyMetrics,
  violations: DisciplineViolation[],
  milestones: Milestone[],
  userPoints: UserPoints[],
  temporal: TemporalContext,
  assessment: StrategicAssessment,
): AdvisorInsight[]
```

Implementation:
1. Call all 5 sub-generators + `generatePointCreepInsights` from advisor-creep.ts
2. Flatten into single array
3. Sort by urgency priority: immediate=0, soon=1, informational=2, positive=3
4. Slice to `MAX_VISIBLE_INSIGHTS`
5. Return

**CRITICAL anti-patterns to avoid (from ADV-08):**
- Never generate text suggesting the user abandon their plan
- Never say "consider switching to X instead"
- Always frame insights in terms of the user's EXISTING plan
- Always reference specific states/species/points -- never generic "your portfolio"
- Never show temporal context when daysSinceLastVisit < 1

Import from existing modules:
- `getUrgencyLevel, daysUntilDate` from urgency.ts
- `TemporalContext, formatTemporalPrefix` from advisor-temporal.ts
- `generatePointCreepInsights` from advisor-creep.ts
- `STATES_MAP` from constants/states.ts
- `formatSpeciesName` from utils.ts
- Types from types/index.ts
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Grep for "generateAdvisorInsights" in advisor.ts to confirm the main function exists.</verify>
  <done>advisor.ts exports generateAdvisorInsights as a pure function. It consumes all existing engine outputs and produces up to 7 prioritized, portfolio-specific AdvisorInsight[] items with urgency-calibrated commentary and actionable CTAs. No plan abandonment suggestions. Temporal context only for returning users.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `generateAdvisorInsights` is importable from `@/lib/engine/advisor`
3. `generatePointCreepInsights` is importable from `@/lib/engine/advisor-creep`
4. The pipeline produces AdvisorInsight[] with all required fields populated
5. Insights are sorted by urgency priority and capped at 7
6. Every insight has a non-empty `cta.href`
7. No insight text contains plan abandonment language
</verification>

<success_criteria>
- advisor.ts and advisor-creep.ts compile without errors
- Pipeline consumes all existing engine outputs (BoardState, PortfolioHealthResult, StrategyMetrics, DisciplineViolation[], Milestone[], UserPoints[], TemporalContext, StrategicAssessment)
- Deadline insights use canonical urgency thresholds (red<=14d, amber<=30d, green>30d)
- Point creep insights reference specific year shifts (e.g., "Year 5 to Year 6")
- All insights have portfolio-specific context (states, species, points, budget)
- Every insight has a CTA with valid href
- Maximum 7 visible insights
- ADV-08 compliance: no plan abandonment suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/05-advisor-voice/05-02-SUMMARY.md`
</output>
