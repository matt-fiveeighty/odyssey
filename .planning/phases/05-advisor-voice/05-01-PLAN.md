---
phase: 05-advisor-voice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types/index.ts
  - src/lib/store.ts
  - src/lib/engine/advisor-temporal.ts
autonomous: true

must_haves:
  truths:
    - "AdvisorInsight type exists with interpretation, recommendation, cta, urgency, and portfolioContext fields"
    - "AdvisorUrgency and AdvisorCTA types are exported and usable by downstream engine/UI code"
    - "TemporalContext type captures lastVisitAt, daysSinceLastVisit, and isReturningUser"
    - "AppState store persists lastVisitAt across sessions and exposes recordVisit action"
    - "buildTemporalContext pure function computes temporal context from a lastVisitAt ISO string"
    - "Zustand hydration race is handled -- recordVisit only fires after hydration completes"
  artifacts:
    - path: "src/lib/types/index.ts"
      provides: "AdvisorInsight, AdvisorUrgency, AdvisorCTA, AdvisorInsightCategory types"
      contains: "AdvisorInsight"
    - path: "src/lib/store.ts"
      provides: "lastVisitAt field and recordVisit action in AppState"
      contains: "lastVisitAt"
    - path: "src/lib/engine/advisor-temporal.ts"
      provides: "TemporalContext type and buildTemporalContext pure function"
      exports: ["TemporalContext", "buildTemporalContext"]
  key_links:
    - from: "src/lib/engine/advisor-temporal.ts"
      to: "src/lib/store.ts"
      via: "reads lastVisitAt from store to build TemporalContext"
      pattern: "lastVisitAt"
---

<objective>
Define the AdvisorInsight type system and temporal context foundation that all subsequent advisor engine and UI code builds upon.

Purpose: ADV-01 requires AdvisorInsight extending BoardSignal with interpretation, recommendation, and CTA. ADV-04 requires temporal context ("Since your last visit..."). This plan creates the type contracts and store plumbing everything else depends on.

Output: Extended types in index.ts, lastVisitAt in AppState, buildTemporalContext pure function.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advisor-voice/05-RESEARCH.md
@src/lib/types/index.ts
@src/lib/store.ts
@src/lib/engine/urgency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdvisorInsight type system in types/index.ts</name>
  <files>src/lib/types/index.ts</files>
  <action>
Add the following types to src/lib/types/index.ts in a new section titled "Advisor Voice System (Phase 5)":

1. `AdvisorUrgency` type: `"immediate" | "soon" | "informational" | "positive"`

2. `AdvisorInsightCategory` type: `"deadline" | "portfolio" | "point_creep" | "discipline" | "milestone" | "temporal" | "calendar"`

3. `AdvisorCTA` interface with fields:
   - `label: string` (e.g., "Apply Now", "Review Deadlines")
   - `href: string` (internal path like "/deadlines" or external F&G URL)
   - `external?: boolean` (true for F&G portal links)

4. `AdvisorInsight` interface with fields:
   - `id: string` (stable ID for dedup, e.g., "deadline-CO-elk")
   - `signal: BoardSignal` (the underlying data signal)
   - `category: AdvisorInsightCategory`
   - `urgency: AdvisorUrgency`
   - `interpretation: string` ("So what?" -- what this means for the user)
   - `recommendation: string` (what to do about it)
   - `cta: AdvisorCTA` (clickable action)
   - `portfolioContext?: string` (user-specific: "Your 3 CO elk points...")
   - `temporalContext?: string` ("Since your last visit (12 days ago)...")
   - `confidence?: DataConfidence` (from VerifiedDatum system)
   - `expiresAt?: string` (ISO date -- insight only relevant until this date)

Place this section after the existing "Board State System" section (around line 35) since it extends BoardSignal.

Do NOT modify any existing types. Only add new ones.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Grep for "AdvisorInsight" in types/index.ts to confirm the type exists.</verify>
  <done>AdvisorInsight, AdvisorUrgency, AdvisorCTA, and AdvisorInsightCategory types are exported from src/lib/types/index.ts and compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: lastVisitAt in AppState store + buildTemporalContext engine</name>
  <files>src/lib/store.ts, src/lib/engine/advisor-temporal.ts</files>
  <action>
**Part A: Store changes (src/lib/store.ts)**

1. Add `lastVisitAt: string | null` field to the AppState interface (after `confirmedAssessment`).

2. Add `recordVisit: () => void` action to the AppState interface.

3. In the useAppStore create function, add initial value `lastVisitAt: null`.

4. Implement `recordVisit`:
   ```typescript
   recordVisit: () => {
     // Read current value BEFORE overwriting -- this is the "last" visit
     const current = useAppStore.getState().lastVisitAt;
     // Only update if the existing value is from a different day (avoid overwriting on same-session reloads)
     const today = new Date().toISOString().slice(0, 10);
     const lastDay = current?.slice(0, 10);
     if (lastDay === today) return; // Same day, don't overwrite
     set({ lastVisitAt: new Date().toISOString() });
   }
   ```

Note: The persist key stays as `hunt-planner-app-v2` -- adding a new field with a default of null is backwards-compatible with existing persisted state (Zustand's persist merge handles this). Do NOT bump the persist key.

**Part B: Temporal context engine (src/lib/engine/advisor-temporal.ts)**

Create a new file `src/lib/engine/advisor-temporal.ts` with:

1. `TemporalContext` interface:
   - `lastVisitAt: string | null` (ISO date of previous visit)
   - `daysSinceLastVisit: number | null` (null = first visit)
   - `currentDate: Date`
   - `isReturningUser: boolean`

2. `buildTemporalContext` pure function:
   ```typescript
   export function buildTemporalContext(
     lastVisitAt: string | null,
     now?: Date,
   ): TemporalContext {
     const currentDate = now ?? new Date();
     if (!lastVisitAt) {
       return { lastVisitAt: null, daysSinceLastVisit: null, currentDate, isReturningUser: false };
     }
     const lastDate = new Date(lastVisitAt);
     const diffMs = currentDate.getTime() - lastDate.getTime();
     const daysSinceLastVisit = Math.floor(diffMs / (1000 * 60 * 60 * 24));
     return {
       lastVisitAt,
       daysSinceLastVisit,
       currentDate,
       isReturningUser: daysSinceLastVisit >= 1,
     };
   }
   ```

3. `formatTemporalPrefix` helper:
   ```typescript
   export function formatTemporalPrefix(temporal: TemporalContext): string | null {
     if (!temporal.isReturningUser || temporal.daysSinceLastVisit === null) return null;
     const days = temporal.daysSinceLastVisit;
     if (days === 1) return "Since yesterday";
     if (days < 7) return `Since your last visit (${days} days ago)`;
     if (days < 30) return `Since your last visit (${Math.floor(days / 7)} weeks ago)`;
     return `Since your last visit (${Math.floor(days / 30)} months ago)`;
   }
   ```

This file has no React imports -- pure TypeScript, pure functions, no side effects.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Run `grep -n "lastVisitAt" src/lib/store.ts` to confirm the field exists. Run `ls src/lib/engine/advisor-temporal.ts` to confirm the file was created.</verify>
  <done>AppState has lastVisitAt field and recordVisit action. advisor-temporal.ts exports TemporalContext, buildTemporalContext, and formatTemporalPrefix. All compile without errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `AdvisorInsight` type is importable from `@/lib/types`
3. `useAppStore.getState().lastVisitAt` returns `null` initially
4. `buildTemporalContext(null)` returns `{ isReturningUser: false }`
5. `buildTemporalContext("2026-02-10", new Date("2026-02-22"))` returns `{ daysSinceLastVisit: 12, isReturningUser: true }`
</verification>

<success_criteria>
- AdvisorInsight, AdvisorUrgency, AdvisorCTA, AdvisorInsightCategory types exported from types/index.ts
- AppState.lastVisitAt persisted, recordVisit guards against same-day overwrites
- buildTemporalContext is a pure function with no React or store dependencies
- No existing types or store behavior modified
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-advisor-voice/05-01-SUMMARY.md`
</output>
