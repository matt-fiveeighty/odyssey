---
phase: 02-shareable-plan-links
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/share/route.ts
  - src/app/shared/[token]/page.tsx
  - src/components/results/ShareButton.tsx
  - src/components/results/ResultsShell.tsx
autonomous: false

must_haves:
  truths:
    - "Visiting /shared/{valid-token} renders the full read-only plan view with all assessment sections"
    - "Visiting /shared/{expired-or-invalid-token} shows a friendly expired/invalid message with a CTA to create your own plan (not a generic 404)"
    - "User clicks 'Share Plan' in results, receives a copied URL, and sees visual feedback ('Link Copied!')"
    - "The shared page is a server component that fetches from Redis -- no client-side state needed to view"
    - "Share link shows expiration date calculated from creation time"
  artifacts:
    - path: "src/app/shared/[token]/page.tsx"
      provides: "Server component rendering shared plan view"
      exports: ["default", "generateMetadata"]
    - path: "src/components/results/ShareButton.tsx"
      provides: "Client component for share link creation with clipboard copy"
      exports: ["ShareButton"]
    - path: "src/components/results/ResultsShell.tsx"
      provides: "Updated results shell with ShareButton in action bar"
  key_links:
    - from: "src/app/shared/[token]/page.tsx"
      to: "src/lib/redis.ts"
      via: "cacheGet to retrieve stored assessment"
      pattern: "cacheGet.*share:"
    - from: "src/app/shared/[token]/page.tsx"
      to: "src/components/results/SharedResultsShell.tsx"
      via: "renders SharedResultsShell with fetched assessment"
      pattern: "SharedResultsShell"
    - from: "src/components/results/ShareButton.tsx"
      to: "src/app/api/share/route.ts"
      via: "POST fetch to /api/share"
      pattern: "fetch.*api/share"
    - from: "src/components/results/ResultsShell.tsx"
      to: "src/components/results/ShareButton.tsx"
      via: "ShareButton rendered in action bar"
      pattern: "ShareButton"
---

<objective>
Wire up the shared plan page route and integrate the Share button into the existing results UI -- completing the end-to-end share flow.

Purpose: Plan 01 created the building blocks (API endpoint + SharedResultsShell). This plan connects them: the server component page fetches the stored assessment and renders it, and the ShareButton in the results UI triggers the full create-copy-share flow.

Output: Complete shareable plan links feature, testable end-to-end
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-shareable-plan-links/02-RESEARCH.md
@.planning/phases/02-shareable-plan-links/02-01-SUMMARY.md

@src/lib/redis.ts
@src/lib/types/index.ts
@src/components/results/ResultsShell.tsx
@src/components/results/SharedResultsShell.tsx
@src/app/api/share/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared plan page route and ShareButton component</name>
  <files>
    src/app/shared/[token]/page.tsx
    src/components/results/ShareButton.tsx
    src/app/api/share/route.ts
  </files>
  <action>
**File 1: Update `src/app/api/share/route.ts`** -- Storage format change

The POST endpoint from Plan 01 stores `body.assessment` directly. We need the creation timestamp to calculate expiration on the shared page. Update the storage call:

- Change `cacheSet(shareKey, body.assessment, "share_links")` to `cacheSet(shareKey, { assessment: body.assessment, createdAt: new Date().toISOString() }, "share_links")`
- Update the response `expiresAt` to derive from the same `createdAt` + `CACHE_TTLS.share_links` seconds
- Import `CACHE_TTLS` if not already imported

This is a small, targeted change to the route.ts created in Plan 01. Do not change rate limiting, validation, or token generation logic.

**File 2: `src/app/shared/[token]/page.tsx`** -- Server component (no "use client")

Create as an async server component. Critical: Next.js 16 passes params as a Promise -- must await.

```typescript
type Props = { params: Promise<{ token: string }> };
```

1. **generateMetadata**: Export `async function generateMetadata({ params }: Props)`. Await params to get token. Call `cacheGet<{ assessment: StrategicAssessment; createdAt: string }>(`share:${token}`)`. If null, return `{ title: "Share Link Not Found | Odyssey Outdoors" }`. Otherwise return `{ title: "Hunt Strategy Plan | Odyssey Outdoors", description: data.assessment.strategyOverview.slice(0, 160) }`.

2. **Default export page component**: Await params, fetch from Redis via `cacheGet<{ assessment: StrategicAssessment; createdAt: string }>(`share:${token}`)`.

    **If null (expired or invalid):** Do NOT call `notFound()`. Instead render a friendly in-page message:
    - Centered layout with `min-h-[60vh] flex flex-col items-center justify-center px-4`
    - Clock icon in a muted circle (same pattern as app's not-found.tsx)
    - Heading: "This share link has expired or doesn't exist"
    - Subtext: "Shared plans expire after 90 days. The link may have been removed or never existed."
    - Button: "Create your own plan" linking to `/plan-builder`
    - This is better UX than a generic 404 page (Pitfall 4 from research).

    **If found:** Calculate `expiresAt` as `new Date(new Date(data.createdAt).getTime() + CACHE_TTLS.share_links * 1000).toISOString()`. Render `<SharedResultsShell assessment={data.assessment} expiresAt={expiresAt} />`.

    Import `SharedResultsShell` from `@/components/results/SharedResultsShell`. Import `cacheGet, CACHE_TTLS` from `@/lib/redis`. Import `Link` from `next/link` and `Button` from `@/components/ui/button` for the expired state. Import `Clock` from `lucide-react`.

**File 3: `src/components/results/ShareButton.tsx`** -- Client component (`"use client"`)

Props: `{ assessment: StrategicAssessment }`

State: `status` as `"idle" | "loading" | "copied" | "error"` (start "idle").

**handleShare async function:**
1. Set status to "loading"
2. Fetch POST `/api/share` with `{ assessment }` body, `Content-Type: application/json`
3. If response not ok:
   - If 429: set status to "error", log rate limit message
   - If 503: set status to "error", log service unavailable
   - Otherwise: set status to "error"
   - In all error cases, `setTimeout(() => setStatus("idle"), 3000)` to auto-reset
   - Return early
4. Parse response JSON to get `{ url }`
5. Copy URL to clipboard with secure context fallback:
   ```typescript
   if (navigator.clipboard) {
     await navigator.clipboard.writeText(url);
   } else {
     const textarea = document.createElement("textarea");
     textarea.value = url;
     textarea.style.position = "fixed";
     textarea.style.opacity = "0";
     document.body.appendChild(textarea);
     textarea.select();
     document.execCommand("copy");
     document.body.removeChild(textarea);
   }
   ```
6. Set status to "copied"
7. `setTimeout(() => setStatus("idle"), 2500)` to auto-reset

**Render:** A Button (variant="outline") with className="gap-1.5":
- `disabled={status === "loading"}`
- Icon: Loader2 (className="w-4 h-4 animate-spin") when loading, Check when copied, AlertCircle when error, Share2 when idle
- Text: "Sharing..." when loading, "Link Copied!" when copied, "Failed" when error, "Share Plan" when idle

Import from lucide-react: `Share2`, `Check`, `Loader2`, `AlertCircle`. Import Button from `@/components/ui/button`. Import StrategicAssessment from `@/lib/types`.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across all modified files. Verify `src/app/shared/[token]/page.tsx` does NOT have "use client" directive. Verify `src/components/results/ShareButton.tsx` has "use client" directive. Verify the page component awaits params before accessing token. Verify the POST route now stores `{ assessment, createdAt }` wrapper.
  </verify>
  <done>
Shared page renders assessment from Redis with friendly expired state handling. ShareButton creates share links and copies URL to clipboard with visual feedback. POST /api/share stores createdAt alongside assessment for accurate expiration calculation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ShareButton into ResultsShell action bar</name>
  <files>src/components/results/ResultsShell.tsx</files>
  <action>
Modify `src/components/results/ResultsShell.tsx` to add the ShareButton to the action bar.

1. Add import: `import { ShareButton } from "./ShareButton";`

2. In the action buttons section (the `div` with `flex items-center justify-between pt-4 border-t`), add `<ShareButton assessment={assessment} />` in the right-side button group, between `PlanExport` and the "Confirm and Start Tracking" button.

The updated right-side group should be:
```tsx
<div className="flex items-center gap-2">
  <PlanExport assessment={assessment} milestones={assessment.milestones} />
  <ShareButton assessment={assessment} />
  <Button onClick={handleConfirmPlan} className="gap-1.5">
    <Check className="w-4 h-4" /> Confirm &amp; Start Tracking
  </Button>
</div>
```

Do NOT change any other part of ResultsShell. Do NOT remove existing imports or functionality.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to confirm the build succeeds. Verify the ShareButton import is present. Verify the ShareButton is rendered in the action bar alongside PlanExport and Confirm.
  </verify>
  <done>ShareButton appears in the results action bar between Export and Confirm buttons. The full share flow is wired end-to-end: click Share Plan -> POST /api/share -> copy URL -> visit /shared/[token] -> see read-only plan.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end share flow</name>
  <files>n/a</files>
  <action>
Human verification checkpoint. Present the following test steps to the user and wait for approval.

Test the complete shareable plan links feature end-to-end:

1. Run `npm run dev` and complete the consultation wizard to get to the results page
2. In the results action bar, verify "Share Plan" button appears between Export and Confirm
3. Click "Share Plan" -- should briefly show "Sharing..." then switch to "Link Copied!"
4. Paste the copied URL into a new browser tab (or incognito window)
5. Verify the shared page shows:
   - "Shared Hunt Strategy" banner with expiration date
   - "Create your own plan" button in the banner
   - Full plan content: hero stats, state recommendations, roadmap timeline, financial summary
   - Bottom CTA section with "Start Your Plan" button
6. Verify no interactive elements (no Edit Plan, Start Over, Confirm buttons on shared page)
7. Visit `/shared/invalid-token-123` and verify friendly expired/invalid message appears (not a generic 404)
8. Click "Create your own plan" on the shared page and verify it navigates to `/plan-builder`
  </action>
  <verify>User confirms all 8 verification steps pass or reports issues to fix.</verify>
  <done>User has approved the end-to-end share flow or issues have been identified for resolution.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` completes successfully
- Share button visible in results action bar
- Clicking Share Plan creates a URL and copies it to clipboard
- Visiting shared URL renders read-only plan view
- Visiting invalid/expired token shows friendly message (not 404)
- Shared page has no Zustand dependencies, no edit functionality
- Expiration date displays correctly on shared page
- "Create your own plan" CTA links to /plan-builder
</verification>

<success_criteria>
1. End-to-end flow works: Share Plan button -> API call -> clipboard copy -> shared page renders assessment
2. Shared page is a server component that fetches from Redis (no client-side state required to view)
3. Expired/invalid tokens show helpful message with CTA instead of generic 404
4. Shared page shows expiration date and "Create your own plan" CTA (SHARE-07)
5. Rate limiting prevents abuse (429 on excessive requests)
6. The feature uses crypto.randomUUID for tokens (SHARE-05)
7. Share links are immutable snapshots (SHARE-04)
</success_criteria>

<output>
After completion, create `.planning/phases/02-shareable-plan-links/02-02-SUMMARY.md`
</output>
