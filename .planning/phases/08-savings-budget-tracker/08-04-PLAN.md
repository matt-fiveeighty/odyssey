---
phase: 08-savings-budget-tracker
plan: 04
type: execute
wave: 4
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - src/lib/engine/advisor-savings.ts
  - src/lib/engine/advisor.ts
  - src/components/advisor/AdvisorCard.tsx
  - src/app/(app)/dashboard/page.tsx
autonomous: true
must_haves:
  truths:
    - "Advisor voice provides specific savings guidance with dollar amounts"
    - "Behind-schedule savings goals generate insights like 'You're $400 behind on your CO elk fund -- increase by $50/mo to get back on track'"
    - "Savings insights never outrank deadline or discipline insights in priority"
    - "AdvisorCard renders a PiggyBank icon for savings category insights"
  artifacts:
    - path: "src/lib/engine/advisor-savings.ts"
      provides: "Savings advisor sub-generator"
      exports: ["generateSavingsInsights"]
    - path: "src/lib/engine/advisor.ts"
      provides: "Pipeline with savings sub-generator integrated"
      contains: "savingsInsights"
    - path: "src/components/advisor/AdvisorCard.tsx"
      provides: "PiggyBank icon for savings category"
      contains: "PiggyBank"
  key_links:
    - from: "src/lib/engine/advisor-savings.ts"
      to: "src/lib/engine/savings-calculator.ts"
      via: "calculateSavingsStatus, calculateCatchUpDelta, calculateFundedDate"
      pattern: "import.*savings-calculator"
    - from: "src/lib/engine/advisor.ts"
      to: "src/lib/engine/advisor-savings.ts"
      via: "import generateSavingsInsights"
      pattern: "import.*advisor-savings"
---

<objective>
Create the savings advisor sub-generator and wire it into the existing advisor pipeline.

Purpose: SAV-06 requires the advisor voice to provide specific savings guidance with dollar amounts. This plan adds a 7th sub-generator to the advisor pipeline that produces insights for behind-schedule savings goals, with exact catch-up amounts and CTAs to the budget page.

Output: advisor-savings.ts sub-generator, updated advisor.ts pipeline, and PiggyBank icon in AdvisorCard.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-savings-budget-tracker/08-RESEARCH.md
@.planning/phases/08-savings-budget-tracker/08-01-SUMMARY.md
@.planning/phases/08-savings-budget-tracker/08-02-SUMMARY.md
@src/lib/engine/advisor.ts
@src/components/advisor/AdvisorCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create advisor-savings.ts sub-generator</name>
  <files>src/lib/engine/advisor-savings.ts</files>
  <action>
Create src/lib/engine/advisor-savings.ts as a pure-function module.

Import dependencies:
```typescript
import type { AdvisorInsight, SavingsGoal, UserGoal, Milestone } from "@/lib/types";
import { calculateSavingsStatus, calculateCatchUpDelta, deriveTargetCost } from "./savings-calculator";
import { STATES_MAP } from "@/lib/constants/states";
import { formatSpeciesName } from "@/lib/utils";
```

Export one function:
```typescript
export function generateSavingsInsights(
  savingsGoals: SavingsGoal[],
  userGoals: UserGoal[],
  milestones: Milestone[],
): AdvisorInsight[]
```

Logic:
1. For each savings goal, find its linked UserGoal.
2. Derive targetCost from milestones using `deriveTargetCost(milestones, sg.goalId)`.
3. Compute target date as `new Date(\`${goal.targetYear}-09-01\`)` (fall of target year).
4. Call `calculateSavingsStatus()` to get traffic light.
5. Generate insights ONLY for amber and red status (green = positive silence, no insight needed):

For RED status:
```typescript
{
  id: `savings-behind-${sg.goalId}`,
  signal: { type: "critical", message: `${stateLabel} ${speciesLabel} fund significantly behind` },
  category: "savings",
  urgency: "soon",           // NEVER "immediate" -- deadlines rank higher
  interpretation: `You're $${deficit.toLocaleString()} behind on your ${stateLabel} ${speciesLabel} fund -- increase by $${Math.ceil(delta)}/mo to get back on track.`,
  recommendation: `Adjust your monthly savings from $${sg.monthlySavings} to $${Math.ceil(sg.monthlySavings + delta)} to meet your ${goal.targetYear} target.`,
  cta: { label: "Update Savings", href: "/budget" },
  portfolioContext: `$${sg.currentSaved.toLocaleString()} of $${targetCost.toLocaleString()} saved`,
}
```

For AMBER status:
```typescript
{
  id: `savings-warning-${sg.goalId}`,
  signal: { type: "warning", message: `${stateLabel} ${speciesLabel} fund slightly behind` },
  category: "savings",
  urgency: "informational",  // Amber is informational, not soon
  interpretation: `Your ${stateLabel} ${speciesLabel} fund is slightly behind -- $${Math.ceil(delta)} extra per month closes the gap.`,
  recommendation: `Small adjustment: increase monthly savings by $${Math.ceil(delta)} to stay on track for ${goal.targetYear}.`,
  cta: { label: "View Savings", href: "/budget" },
  portfolioContext: `$${sg.currentSaved.toLocaleString()} of $${targetCost.toLocaleString()} saved`,
}
```

Where:
- `deficit = targetCost - sg.currentSaved`
- `delta = calculateCatchUpDelta(targetCost, sg.currentSaved, sg.monthlySavings, targetDate)`
- `stateLabel = STATES_MAP[goal.stateId]?.abbreviation ?? goal.stateId`
- `speciesLabel = formatSpeciesName(goal.speciesId)`

6. Sort by severity (red before amber).
7. Cap at 2 insights maximum (most critical first).
8. Skip goals where targetCost is 0 (no milestones linked) or UserGoal not found.

CRITICAL per research pitfall #4: savings insights use `urgency: "soon"` for red and `urgency: "informational"` for amber. NEVER `"immediate"` -- deadline and discipline insights must always rank higher in the advisor pipeline.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. The function is exported and importable.</verify>
  <done>generateSavingsInsights produces up to 2 advisor insights for behind-schedule savings goals with specific dollar amounts in interpretation text.</done>
</task>

<task type="auto">
  <name>Task 2: Wire savings into advisor pipeline and AdvisorCard</name>
  <files>src/lib/engine/advisor.ts, src/components/advisor/AdvisorCard.tsx</files>
  <action>
**In src/lib/engine/advisor.ts:**

1. Add import at top:
   ```typescript
   import { generateSavingsInsights } from "./advisor-savings";
   import type { SavingsGoal } from "@/lib/types";
   ```

2. Add `savingsGoals: SavingsGoal[]` parameter to the `generateAdvisorInsights` function signature. Add it as the LAST parameter (after `assessment`) to minimize changes to existing call sites:
   ```typescript
   export function generateAdvisorInsights(
     boardState: BoardState,
     health: PortfolioHealthResult,
     metrics: StrategyMetrics,
     violations: DisciplineViolation[],
     milestones: Milestone[],
     userPoints: UserPoints[],
     temporal: TemporalContext,
     assessment: StrategicAssessment,
     savingsGoals: SavingsGoal[] = [],    // NEW -- defaults to [] for backwards compat
     userGoals: UserGoal[] = [],          // NEW -- needed for savings context
   ): AdvisorInsight[]
   ```

   Also add `UserGoal` to the type imports from "@/lib/types".

3. Inside the function, after `const creepInsights = ...`, add:
   ```typescript
   const savingsInsights = generateSavingsInsights(savingsGoals, userGoals, milestones);
   ```

4. Add `...savingsInsights,` to the `all` array, AFTER `...creepInsights,`.

5. The existing sort by urgency priority and cap at MAX_VISIBLE_INSIGHTS handles ordering automatically. No changes needed to sorting logic.

**In src/app/(app)/dashboard/page.tsx:**

Update the `generateAdvisorInsights` call to pass `savingsGoals` and `userGoals`:
```typescript
return generateAdvisorInsights(
  boardState,
  health,
  metrics,
  violations,
  milestones,
  userPoints,
  temporal,
  confirmedAssessment,
  savingsGoals,    // NEW
  userGoals,       // NEW
);
```

Add `savingsGoals` to the useMemo dependency array for advisorInsights.

**In src/components/advisor/AdvisorCard.tsx:**

1. Add PiggyBank to the lucide-react import:
   ```typescript
   import { Clock, Shield, TrendingUp, AlertTriangle, Target, RefreshCw, Calendar, ArrowRight, ExternalLink, PiggyBank } from "lucide-react";
   ```

2. Add "savings" to the CATEGORY_ICONS map:
   ```typescript
   const CATEGORY_ICONS: Record<AdvisorInsightCategory, React.ComponentType<{ className?: string }>> = {
     deadline: Clock,
     portfolio: Shield,
     point_creep: TrendingUp,
     discipline: AlertTriangle,
     milestone: Target,
     temporal: RefreshCw,
     calendar: Calendar,
     savings: PiggyBank,    // Phase 8
   };
   ```
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Check that CATEGORY_ICONS covers all members of AdvisorInsightCategory (no TypeScript exhaustiveness error). The advisor pipeline now includes savings insights in its output.</verify>
  <done>Advisor pipeline generates savings insights with PiggyBank icon. Behind-schedule goals produce specific dollar-amount guidance. Savings insights rank below deadlines and discipline in priority.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `generateSavingsInsights` returns empty array for green-status goals
3. Red-status insights use `urgency: "soon"` (not "immediate")
4. Amber-status insights use `urgency: "informational"`
5. CATEGORY_ICONS includes savings -> PiggyBank
6. Dashboard advisor section shows savings insights when goals are behind
</verification>

<success_criteria>
- Advisor produces savings insights with specific dollar amounts (SAV-06)
- Savings insights never outrank deadline or discipline insights
- PiggyBank icon renders for savings category in AdvisorCard
- Default parameters ensure backwards compatibility (no changes needed in any other call site)
</success_criteria>

<output>
After completion, create `.planning/phases/08-savings-budget-tracker/08-04-SUMMARY.md`
</output>
