---
phase: 08-savings-budget-tracker
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types/index.ts
  - src/lib/store.ts
  - src/components/budget/SavingsGoalCard.tsx
autonomous: true
must_haves:
  truths:
    - "Savings goals persist across page navigation and browser refresh"
    - "Each savings goal is linked to a specific UserGoal via goalId"
    - "User can add a contribution and see currentSaved increase"
    - "Removing a savings goal removes it from Zustand (not just local state)"
  artifacts:
    - path: "src/lib/types/index.ts"
      provides: "SavingsGoal, SavingsContribution, SavingsStatus types and savings category on AdvisorInsightCategory"
      contains: "SavingsGoal"
    - path: "src/lib/store.ts"
      provides: "savingsGoals[] state with CRUD actions in AppState"
      contains: "savingsGoals"
    - path: "src/components/budget/SavingsGoalCard.tsx"
      provides: "Zustand-backed savings section replacing ephemeral useState"
      contains: "useAppStore"
  key_links:
    - from: "src/lib/store.ts"
      to: "src/lib/types/index.ts"
      via: "import SavingsGoal type"
      pattern: "import.*SavingsGoal.*from.*types"
    - from: "src/components/budget/SavingsGoalCard.tsx"
      to: "src/lib/store.ts"
      via: "useAppStore for savingsGoals CRUD"
      pattern: "useAppStore"
---

<objective>
Add SavingsGoal types, Zustand store integration, and refactor the existing SavingsGoalCard to persist savings data.

Purpose: This is the data foundation for the entire savings tracker. The existing SavingsGoalCard uses useState (ephemeral -- data lost on navigation). Migrating to Zustand persistence under the existing `hunt-planner-app-v2` key is the core fix. All subsequent plans (calculator, progress rings, advisor) depend on this persisted data.

Output: SavingsGoal/SavingsContribution/SavingsStatus types in types/index.ts, savingsGoals slice in AppState, and a refactored SavingsGoalCard that reads/writes from Zustand.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-savings-budget-tracker/08-RESEARCH.md
@src/lib/types/index.ts
@src/lib/store.ts
@src/components/budget/SavingsGoalCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SavingsGoal types and extend AdvisorInsightCategory</name>
  <files>src/lib/types/index.ts</files>
  <action>
Add the following types to src/lib/types/index.ts in a new section after the Advisor Voice System section:

```typescript
// ============================================================================
// Savings & Budget Tracker (Phase 8)
// ============================================================================

export type SavingsStatus = "green" | "amber" | "red";

export interface SavingsContribution {
  amount: number;
  date: string;       // ISO date string
  note?: string;      // "February deposit", "Tax refund bonus"
}

export interface SavingsGoal {
  id: string;
  goalId: string;              // Links to UserGoal.id (SAV-02)
  currentSaved: number;        // Running total of contributions
  monthlySavings: number;      // User-set monthly contribution amount
  contributions: SavingsContribution[];  // Audit trail
  createdAt: string;           // ISO date
  updatedAt: string;           // ISO date
}
```

IMPORTANT: Do NOT include `targetCost` on SavingsGoal. Target cost is always derived from milestones at read time (per research recommendation -- avoids stale cost bug when goals are updated).

Also extend AdvisorInsightCategory to include "savings":
```typescript
export type AdvisorInsightCategory =
  | "deadline"
  | "portfolio"
  | "point_creep"
  | "discipline"
  | "milestone"
  | "temporal"
  | "calendar"
  | "savings";    // Phase 8
```
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `SavingsGoal` in types/index.ts confirms the interface exists. Grep for `"savings"` in AdvisorInsightCategory confirms the category was added.</verify>
  <done>SavingsGoal, SavingsContribution, SavingsStatus types exported from types/index.ts. AdvisorInsightCategory includes "savings".</done>
</task>

<task type="auto">
  <name>Task 2: Add savingsGoals slice to AppState Zustand store</name>
  <files>src/lib/store.ts</files>
  <action>
Extend the AppState interface in src/lib/store.ts with:

```typescript
// Savings goals (Phase 8)
savingsGoals: SavingsGoal[];
addSavingsGoal: (goal: SavingsGoal) => void;
updateSavingsGoal: (id: string, updates: Partial<Pick<SavingsGoal, 'currentSaved' | 'monthlySavings'>>) => void;
removeSavingsGoal: (id: string) => void;
addContribution: (goalId: string, amount: number, note?: string) => void;
```

Add the import for SavingsGoal to the existing type imports from "@/lib/types".

In the useAppStore create() implementation, add:

1. Initial state: `savingsGoals: [],` -- Zustand persist shallow merge handles existing users who don't have this field yet (it defaults to []). Do NOT bump the persist key from "hunt-planner-app-v2".

2. Action implementations:
- `addSavingsGoal: (goal) => set((state) => ({ savingsGoals: [...state.savingsGoals, goal] })),`
- `updateSavingsGoal: (id, updates) => set((state) => ({ savingsGoals: state.savingsGoals.map((sg) => sg.id === id ? { ...sg, ...updates, updatedAt: new Date().toISOString() } : sg) })),`
- `removeSavingsGoal: (id) => set((state) => ({ savingsGoals: state.savingsGoals.filter((sg) => sg.id !== id) })),`
- `addContribution: (goalId, amount, note) => set((state) => ({ savingsGoals: state.savingsGoals.map((sg) => sg.id !== goalId ? sg : { ...sg, currentSaved: sg.currentSaved + amount, contributions: [...sg.contributions, { amount, date: new Date().toISOString(), note }], updatedAt: new Date().toISOString() }) })),`

Also: when `removeUserGoal` is called, cascade-remove any linked savings goal. Inside the existing `removeUserGoal` action, after filtering userGoals and milestones, also filter savingsGoals:
```typescript
savingsGoals: state.savingsGoals.filter((sg) => sg.goalId !== id),
```
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Check that the AppState interface includes savingsGoals and all 4 actions. Check that removeUserGoal cascades to savingsGoals.</verify>
  <done>AppState has savingsGoals[], addSavingsGoal, updateSavingsGoal, removeSavingsGoal, addContribution actions. Persist key unchanged. Cascade delete wired to removeUserGoal.</done>
</task>

<task type="auto">
  <name>Task 3: Refactor SavingsGoalCard to use Zustand persistence</name>
  <files>src/components/budget/SavingsGoalCard.tsx</files>
  <action>
Refactor src/components/budget/SavingsGoalCard.tsx to replace all useState-based savings goal storage with Zustand actions from useAppStore.

Key changes:

1. REMOVE the local `SavingsGoal` interface (it's now in types/index.ts). Import it from "@/lib/types" instead.

2. REMOVE these useState hooks from SavingsGoalsSection:
   - `const [savingsGoals, setSavingsGoals] = useState<SavingsGoal[]>([]);`
   - `const [dismissedSuggestions, setDismissedSuggestions] = useState<Set<string>>(new Set());`

   Replace with:
   - `const { savingsGoals, addSavingsGoal, updateSavingsGoal: updateSG, removeSavingsGoal, addContribution } = useAppStore();`
   - Keep dismissedSuggestions as useState (it's session-only, intentionally ephemeral).

3. Update `activateSuggestion` to call `addSavingsGoal()` with the new SavingsGoal shape:
   ```typescript
   addSavingsGoal({
     id: crypto.randomUUID(),
     goalId: suggestion.goal.id,      // Link to UserGoal
     currentSaved: 0,
     monthlySavings: suggestion.monthlySavings,
     contributions: [],
     createdAt: new Date().toISOString(),
     updatedAt: new Date().toISOString(),
   });
   ```
   Note: No `targetCost` or `title` or `targetDate` stored. These are derived at render time.

4. Update `addSavingsGoal` (the manual add function) similarly. The user-created goal dialog needs a way to link to a UserGoal. For manually created goals (not from suggestions), let the user select a UserGoal from a dropdown. If no UserGoal is selected, don't allow creation. Remove the manual `newGoalTitle` and `newGoalTarget` inputs -- title and target cost derive from the linked UserGoal and its milestones.

   Replace the "New Goal" dialog content:
   - Show a dropdown/list of userGoals that don't already have a savings goal
   - Show the derived target cost from milestones for the selected goal
   - Let user set monthlySavings amount
   - On create, call addSavingsGoal with goalId linking to selected UserGoal

5. Update `SavingsGoalItem` to derive title and targetCost from the linked UserGoal:
   - Accept `userGoals` and `milestones` as additional props (or access via useAppStore)
   - Derive `title` from `userGoals.find(g => g.id === goal.goalId)?.title`
   - Derive `targetCost` from milestones: `milestones.filter(m => m.planId === goal.goalId).reduce((s, m) => s + m.totalCost, 0)`
   - Use `addContribution(goal.id, amount)` instead of local setSavingsGoals

6. Update `removeGoal` to call `removeSavingsGoal(goalId)` from store.

7. Update the suggestedSavings filter to check `!savingsGoals.some(sg => sg.goalId === s.goal.id)` instead of matching on stateId/speciesId.

8. Keep the same visual layout -- Card with progress bar, quick-update buttons, suggested savings section. The UI stays the same, only the data source changes from useState to Zustand.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Open /budget page in browser, add a savings goal from suggestions, navigate away and back -- the goal should persist. Add a contribution -- the amount should persist across page navigation.</verify>
  <done>SavingsGoalCard reads/writes from Zustand store. Goals survive page navigation and browser refresh. Manual goal creation requires linking to a UserGoal. Target cost derived from milestones, not stored.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. SavingsGoal type exists in types/index.ts without a targetCost field
3. AppState in store.ts has savingsGoals: SavingsGoal[] with default []
4. No useState for savingsGoals in SavingsGoalCard.tsx
5. Persist key is still "hunt-planner-app-v2" (NOT bumped)
</verification>

<success_criteria>
- Types are exported and importable from "@/lib/types"
- Savings goals persist in Zustand under hunt-planner-app-v2
- SavingsGoalCard reads from and writes to Zustand
- Removing a UserGoal cascades to remove its linked SavingsGoal
- No regressions in existing AppState functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-savings-budget-tracker/08-01-SUMMARY.md`
</output>
