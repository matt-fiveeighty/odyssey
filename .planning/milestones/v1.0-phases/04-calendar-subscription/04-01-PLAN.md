---
phase: 04-calendar-subscription
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/calendar/ics-builder.ts
  - src/lib/calendar/uid-generator.ts
  - src/lib/calendar-export.ts
autonomous: true

must_haves:
  truths:
    - "buildICS() generates valid RFC 5545 iCalendar output with CRLF line endings, METHOD:PUBLISH, and PRODID"
    - "buildICS() runs in both Node.js (server-side API route) and browser (client-side download) without any DOM dependencies"
    - "generateStableUID() returns the same UID for the same event content every time, preventing duplicate events on calendar refresh"
    - "generateStableUID() returns different UIDs for events that differ in state, species, type, or date"
    - "VTIMEZONE blocks are included for all referenced timezones using timezones-ical-library"
    - "Existing calendar download functionality (exportDeadline, exportPlanItem) continues working via the refactored module"
  artifacts:
    - path: "src/lib/calendar/ics-builder.ts"
      provides: "Isomorphic ICS string generation with VTIMEZONE support"
      exports: ["CalendarEvent", "ICSEventInput", "buildICS", "buildCalendarEventsFromGrid"]
    - path: "src/lib/calendar/uid-generator.ts"
      provides: "Content-derived stable UID generation using SHA-256"
      exports: ["EventIdentity", "generateStableUID"]
    - path: "src/lib/calendar-export.ts"
      provides: "Browser-only download trigger delegating to ics-builder"
      exports: ["downloadICS", "exportDeadline", "exportPlanItem"]
  key_links:
    - from: "src/lib/calendar/ics-builder.ts"
      to: "src/lib/calendar/uid-generator.ts"
      via: "imports generateStableUID for event UID generation"
      pattern: "import.*generateStableUID.*from.*uid-generator"
    - from: "src/lib/calendar/ics-builder.ts"
      to: "src/lib/engine/calendar-grid.ts"
      via: "buildCalendarEventsFromGrid uses CalendarGrid types"
      pattern: "import.*CalendarGrid.*from.*calendar-grid"
    - from: "src/lib/calendar-export.ts"
      to: "src/lib/calendar/ics-builder.ts"
      via: "downloadICS delegates ICS string generation to buildICS"
      pattern: "import.*buildICS.*from.*calendar/ics-builder"
    - from: "src/lib/calendar/ics-builder.ts"
      to: "timezones-ical-library"
      via: "imports tzlib_get_ical_block for VTIMEZONE generation"
      pattern: "import.*tzlib_get_ical_block.*from.*timezones-ical-library"
---

<objective>
Extract and refactor the existing browser-only buildICS function into an isomorphic ICS generation module with content-derived stable UIDs and VTIMEZONE support. This is the pure-logic foundation that the subscription endpoint (Plan 02) will consume.

Purpose: The existing calendar-export.ts mixes ICS string generation with DOM-dependent download logic (Blob, createElement), preventing server-side use. This plan separates concerns: ics-builder.ts handles pure string generation (isomorphic), uid-generator.ts handles deterministic UID hashing, and calendar-export.ts becomes a thin browser-only wrapper. All requirements ICS-01, ICS-04, ICS-06, ICS-07 are addressed here.

Output: Three files -- `src/lib/calendar/ics-builder.ts` (isomorphic ICS generation), `src/lib/calendar/uid-generator.ts` (stable UIDs), and refactored `src/lib/calendar-export.ts` (browser-only download wrapper).
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-calendar-subscription/04-RESEARCH.md

@src/lib/calendar-export.ts
@src/lib/engine/calendar-grid.ts
@src/lib/types/index.ts
@src/lib/constants/states.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install timezones-ical-library and create uid-generator.ts + ics-builder.ts</name>
  <files>
    src/lib/calendar/uid-generator.ts
    src/lib/calendar/ics-builder.ts
  </files>
  <action>
**Step 0: Install dependency**

Run `npm install timezones-ical-library` to add the VTIMEZONE generation library.

**Step 1: Create `src/lib/calendar/uid-generator.ts`**

Content-derived stable UID generation using SHA-256, ensuring the same event content always produces the same UID (ICS-04).

Export these:

1. **`EventIdentity` interface:**
```typescript
export interface EventIdentity {
  stateId: string;
  speciesId: string;
  itemType: string;  // "application" | "hunt" | "point_purchase" | "scout" | "deadline" | "prep"
  year: number;
  month: number;     // 1-12
  day?: number;
}
```

2. **`generateStableUID(identity: EventIdentity): string`:**
   - Create a deterministic string by JSON.stringify-ing a sorted-key object: `{ day: identity.day ?? 0, month: identity.month, species: identity.speciesId, state: identity.stateId, type: identity.itemType, year: identity.year }`. Use alphabetical key order to guarantee determinism.
   - Hash with `createHash("sha256").update(content).digest("hex").slice(0, 16)` using Node.js crypto (import `{ createHash } from "crypto"`).
   - Return `${hash}@odysseyoutdoors.com` (RFC 5545 UID format: unique-id@domain).

The `crypto` module works in both Node.js and Next.js Edge Runtime (via polyfill). No DOM dependencies.

**Step 2: Create `src/lib/calendar/ics-builder.ts`**

Isomorphic ICS generation module -- zero DOM dependencies (ICS-01). This file must NOT import Blob, document, URL, or any browser API.

Export these types:

1. **`CalendarEvent` interface** (matches existing shape + additions):
```typescript
export interface CalendarEvent {
  title: string;
  description?: string;
  startDate: Date;
  endDate?: Date;
  isAllDay?: boolean;
  location?: string;
}
```

2. **`ICSEventInput` interface** (enriched with identity for stable UIDs):
```typescript
export interface ICSEventInput extends CalendarEvent {
  identity?: EventIdentity;  // If provided, generates stable UID; if omitted, falls back to content-based hash from title+date
}
```

3. **`buildICS(events: ICSEventInput[], options?: { timezones?: string[]; calendarName?: string }): string`**

The main ICS generation function. Implementation:

a. Start with VCALENDAR header lines:
   ```
   BEGIN:VCALENDAR
   VERSION:2.0
   PRODID:-//Odyssey Outdoors//Hunt Planner//EN
   CALSCALE:GREGORIAN
   METHOD:PUBLISH
   ```
   Add `X-WR-CALNAME:${options.calendarName}` if calendarName provided (defaults to "Hunt Planner Calendar").

b. **VTIMEZONE blocks (ICS-06):** If `options.timezones` is provided, iterate over unique timezone IDs. For each:
   - Call `tzlib_get_ical_block(tz)` from timezones-ical-library
   - The library returns a string array or string -- handle both cases. If it returns an array, use the first element (the standard VTIMEZONE block).
   - Push the VTIMEZONE block (it already includes BEGIN:VTIMEZONE...END:VTIMEZONE)
   - Wrap in try/catch -- log warning and skip invalid timezone IDs

c. **VEVENT blocks:** For each event:
   - Generate UID: If `event.identity` exists, use `generateStableUID(event.identity)`. Otherwise, create a fallback identity from title + date: `createHash("sha256").update(event.title + formatICSDate(event.startDate)).digest("hex").slice(0, 16) + "@odysseyoutdoors.com"`.
   - `DTSTAMP:${formatICSTimestamp(new Date())}Z` (always UTC with Z suffix per RFC 5545 section 3.8.7.2)
   - `DTSTART;VALUE=DATE:${formatICSDate(event.startDate)}` (all-day format)
   - `DTEND;VALUE=DATE:${formatICSDate(endExclusive)}` where endExclusive is endDate (or startDate) + 1 day (exclusive end per iCal spec)
   - `SUMMARY:${escapeICS(event.title)}`
   - `DESCRIPTION:${escapeICS(event.description)}` if description exists
   - `LOCATION:${escapeICS(event.location)}` if location exists

d. Close with `END:VCALENDAR`

e. Join all lines with `\r\n` (CRLF -- RFC 5545 requirement, ICS-07 compliance). Do NOT use `\n`.

Internal helper functions (NOT exported):

- `pad(n: number): string` -- zero-pad to 2 digits
- `formatICSDate(date: Date): string` -- format as YYYYMMDD (VALUE=DATE)
- `formatICSTimestamp(date: Date): string` -- format as YYYYMMDDTHHMMSS using UTC methods (getUTCFullYear, getUTCMonth, etc.)
- `escapeICS(text: string): string` -- escape backslash, semicolon, comma, newline per RFC 5545 section 3.3.11

4. **`buildCalendarEventsFromGrid(grid: CalendarGrid, year: number, stateTimezones?: Record<string, string>): { events: ICSEventInput[]; timezones: string[] }`**

Converts a CalendarGrid (from Phase 3's calendar-grid.ts) into ICSEventInput array for the subscription endpoint. Also collects unique timezone IDs.

Implementation:
- Import `CalendarGrid`, `CalendarRow`, `CalendarSlotData` from `@/lib/engine/calendar-grid`
- For each row in grid.rows, for each month's slots:
  - Build `ICSEventInput` with:
    - `title`: `${row.stateAbbr}: ${slot.title}` (prefix with state abbreviation for calendar readability)
    - `description`: `${slot.description}\n\nState: ${row.stateName}\nType: ${slot.tagType}${slot.estimatedCost > 0 ? '\nEstimated Cost: $' + slot.estimatedCost.toLocaleString() : ''}`
    - `startDate`: `new Date(year, slot.month - 1, slot.day ?? 1)`
    - `endDate`: If slot.endMonth and slot.endDay exist, `new Date(year, slot.endMonth - 1, slot.endDay)`. Else if slot.endDay, `new Date(year, slot.month - 1, slot.endDay)`. Else undefined.
    - `isAllDay`: true
    - `location`: `${row.stateName} (${row.stateAbbr})`
    - `identity`: `{ stateId: slot.stateId, speciesId: slot.speciesId, itemType: slot.itemType, year, month: slot.month, day: slot.day }`
  - If `stateTimezones?.[row.stateId]` exists, add to timezones set
- Return `{ events, timezones: Array.from(timezonesSet) }`

**Imports for ics-builder.ts:**
- `import { createHash } from "crypto";`
- `import { generateStableUID } from "./uid-generator";`
- `import type { EventIdentity } from "./uid-generator";`
- `import { tzlib_get_ical_block } from "timezones-ical-library";`
- `import type { CalendarGrid, CalendarSlotData } from "@/lib/engine/calendar-grid";`

Do NOT import Blob, document, URL, window, or any browser-only API. This module MUST be isomorphic.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify:
- `grep "export function buildICS" src/lib/calendar/ics-builder.ts` confirms main function
- `grep "export function generateStableUID" src/lib/calendar/uid-generator.ts` confirms UID function
- `grep "METHOD:PUBLISH" src/lib/calendar/ics-builder.ts` confirms ICS-07
- `grep '\\\\r\\\\n' src/lib/calendar/ics-builder.ts` confirms CRLF line endings
- `grep "tzlib_get_ical_block" src/lib/calendar/ics-builder.ts` confirms VTIMEZONE integration
- `grep -E "document|Blob|URL\\.create|window" src/lib/calendar/ics-builder.ts` returns NO matches (isomorphic)
- `grep -E "document|Blob|URL\\.create|window" src/lib/calendar/uid-generator.ts` returns NO matches (isomorphic)
  </verify>
  <done>ics-builder.ts generates RFC 5545 compliant ICS output with stable content-derived UIDs, VTIMEZONE support via timezones-ical-library, METHOD:PUBLISH header, CRLF line endings, and zero DOM dependencies. uid-generator.ts provides deterministic SHA-256-based UIDs. Both modules are fully isomorphic.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor calendar-export.ts to delegate to ics-builder.ts</name>
  <files>src/lib/calendar-export.ts</files>
  <action>
Refactor the existing `src/lib/calendar-export.ts` to be a thin browser-only wrapper that delegates ICS generation to the new isomorphic `ics-builder.ts`. This preserves the existing public API that 4 files depend on (`exportDeadline`, `exportPlanItem`).

**Changes:**

1. **Remove** all internal ICS generation logic from calendar-export.ts:
   - Remove `pad()`, `formatICSDate()`, `uid()`, `escapeICS()`, `CalendarEvent` interface, and `buildICS()` function -- these are now in ics-builder.ts.

2. **Import from ics-builder.ts:**
   ```typescript
   import { buildICS } from "@/lib/calendar/ics-builder";
   import type { ICSEventInput } from "@/lib/calendar/ics-builder";
   ```

3. **Keep `downloadICS` as-is** but use the imported buildICS:
   ```typescript
   export function downloadICS(events: ICSEventInput[], filename: string) {
     const ics = buildICS(events);
     const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
     const url = URL.createObjectURL(blob);
     const a = document.createElement("a");
     a.href = url;
     a.download = filename.endsWith(".ics") ? filename : `${filename}.ics`;
     document.body.appendChild(a);
     a.click();
     document.body.removeChild(a);
     URL.revokeObjectURL(url);
   }
   ```

4. **Keep `exportDeadline` and `exportPlanItem`** with identical signatures and behavior. The only change is they now create `ICSEventInput[]` instead of the old `CalendarEvent[]` (same shape, compatible). Since these create simple events without EventIdentity, the fallback UID generation in buildICS (hash of title+date) will be used -- which is fine for individual event downloads where duplication is not a concern.

5. **Re-export CalendarEvent type** for backward compatibility: `export type { CalendarEvent, ICSEventInput } from "@/lib/calendar/ics-builder";`

**Existing consumers (NO changes needed to these files -- verify they still compile):**
- `src/app/(app)/deadlines/page.tsx` -- imports `exportDeadline`
- `src/components/planner/YearCalendar.tsx` -- imports `exportPlanItem`
- `src/components/roadmap/RoadmapTimeline.tsx` -- imports `exportDeadline`
- `src/components/roadmap/MoveCard.tsx` -- imports `exportDeadline`

All 4 import from `@/lib/calendar-export` and call the same named exports with the same arguments. The refactoring is internal-only.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across the entire project (all 4 consumers still compile). Verify:
- `grep "import.*buildICS.*from.*calendar/ics-builder" src/lib/calendar-export.ts` confirms delegation
- `grep "export function downloadICS" src/lib/calendar-export.ts` confirms browser download still exported
- `grep "export function exportDeadline" src/lib/calendar-export.ts` confirms API preserved
- `grep "export function exportPlanItem" src/lib/calendar-export.ts` confirms API preserved
- `grep -c "document\|Blob\|createElement" src/lib/calendar-export.ts` returns 4+ (browser APIs are in this file, NOT in ics-builder)
- `grep -c "pad\|formatICSDate\|escapeICS\|uid()" src/lib/calendar-export.ts` returns 0 (moved to ics-builder)
  </verify>
  <done>calendar-export.ts is now a thin browser-only wrapper. All ICS generation logic lives in the isomorphic ics-builder.ts. The 4 existing consumers (deadlines page, YearCalendar, RoadmapTimeline, MoveCard) continue working without any changes. The public API (exportDeadline, exportPlanItem, downloadICS) is unchanged.</done>
</task>

</tasks>

<technical_notes>
- The `crypto` module's `createHash` is available in Node.js natively and in Next.js Edge Runtime via built-in polyfill. No separate polyfill needed.
- `timezones-ical-library`'s `tzlib_get_ical_block` may return a string or string array depending on the timezone. The research confirms checking the return type and handling both cases.
- VTIMEZONE blocks are technically optional for all-day events (VALUE=DATE), but including them is good practice and satisfies ICS-06. The subscription endpoint will pass state timezones from the `deadlineTimezone` field on State objects.
- The fallback UID generation (hash of title+date) is used only for individual event downloads via exportDeadline/exportPlanItem where duplication prevention is irrelevant. Subscription events always have EventIdentity.
- Calendar-export.ts consumers use named imports (`import { exportDeadline }`) not default imports, so the re-export works seamlessly.
- All 11 states have `deadlineTimezone` set in states.ts -- the mapping is: CO/WY/MT/UT/NM -> America/Denver, OR/NV/AK -> America/Los_Angeles/Phoenix/Anchorage, ID -> America/Boise, KS -> America/Chicago.
</technical_notes>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds (confirms both server and client compilation)
- ics-builder.ts has zero DOM imports (grep -E "document|Blob|URL\.create|window" returns nothing)
- uid-generator.ts generates deterministic UIDs (same input = same output)
- calendar-export.ts delegates to ics-builder.ts for ICS generation
- All 4 existing consumers compile without changes
- ICS output contains METHOD:PUBLISH, PRODID, CALSCALE:GREGORIAN
- ICS output uses \r\n line endings (CRLF)
- timezones-ical-library is in package.json dependencies
</verification>

<success_criteria>
1. buildICS() is fully isomorphic -- works in Node.js API routes and browser (ICS-01)
2. generateStableUID() produces deterministic content-derived UIDs using SHA-256 (ICS-04)
3. ICS output includes METHOD:PUBLISH header for subscription behavior (ICS-07)
4. VTIMEZONE blocks included for referenced timezones via timezones-ical-library (ICS-06)
5. CRLF line endings used throughout ICS output (RFC 5545 compliance)
6. Existing exportDeadline and exportPlanItem continue working unchanged for all 4 consumers
</success_criteria>

<output>
After completion, create `.planning/phases/04-calendar-subscription/04-01-SUMMARY.md`
</output>
