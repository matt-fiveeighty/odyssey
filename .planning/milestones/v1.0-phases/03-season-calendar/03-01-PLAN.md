---
phase: 03-season-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/urgency.ts
  - src/lib/engine/calendar-grid.ts
autonomous: true

must_haves:
  truths:
    - "getUrgencyLevel returns 'red' for dates <=14 days away, 'amber' for <=30, 'green' for >30, 'overdue' for past, 'none' for missing dates"
    - "urgencyColorClass returns Tailwind classes for each urgency level using the app's oklch color system"
    - "buildCalendarGrid reshapes a StrategicAssessment into a CalendarGrid with state rows, 12 month columns, and monthly cost totals"
    - "CalendarGrid.rows contains one CalendarRow per state found in the target year's roadmap actions"
    - "CalendarGrid.monthlyCosts is a 12-element array with the sum of all slot costs per month"
    - "Each CalendarSlotData has id, itemType, stateId, speciesId, month, estimatedCost, tagType, urgency, and dueDate"
  artifacts:
    - path: "src/lib/engine/urgency.ts"
      provides: "Shared urgency calculation and color classes"
      exports: ["UrgencyLevel", "getUrgencyLevel", "urgencyColorClass"]
    - path: "src/lib/engine/calendar-grid.ts"
      provides: "Pure function to build calendar grid from assessment data"
      exports: ["CalendarSlotData", "CalendarRow", "CalendarGrid", "buildCalendarGrid"]
  key_links:
    - from: "src/lib/engine/calendar-grid.ts"
      to: "src/lib/engine/urgency.ts"
      via: "imports getUrgencyLevel for slot urgency calculation"
      pattern: "import.*getUrgencyLevel.*from.*urgency"
    - from: "src/lib/engine/calendar-grid.ts"
      to: "src/lib/constants/states.ts"
      via: "imports STATES_MAP for state name/abbreviation/color lookup"
      pattern: "import.*STATES_MAP.*from.*constants/states"
    - from: "src/lib/engine/calendar-grid.ts"
      to: "src/lib/types/index.ts"
      via: "imports StrategicAssessment, RoadmapAction types"
      pattern: "import.*StrategicAssessment.*from.*types"
---

<objective>
Create the shared urgency utility and calendar grid data model -- the pure-logic foundation that the calendar UI (Plan 02) will consume.

Purpose: These are dependency-free pure functions with no UI. Urgency extraction eliminates duplication across 3 existing files. The calendar grid reshapes existing StrategicAssessment data (roadmap actions + milestones) into a state-by-month grid structure optimized for swimlane rendering.

Output: Two new engine files (`urgency.ts`, `calendar-grid.ts`) with exported types and pure functions.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-season-calendar/03-RESEARCH.md

@src/lib/types/index.ts
@src/lib/constants/states.ts
@src/lib/engine/roadmap-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared urgency utility (urgency.ts)</name>
  <files>src/lib/engine/urgency.ts</files>
  <action>
Create `src/lib/engine/urgency.ts` with a shared urgency calculation that replaces the duplicated logic found in:
- `src/app/(app)/deadlines/page.tsx` (lines 111-123, urgencyClass/urgencyBorder with 3d/7d/14d thresholds)
- `src/components/goals/MilestoneCalendar.tsx` (line 305, isUrgent with 14d threshold)
- `src/components/results/sections/YearOneActionPlan.tsx` (line 196, isUrgent with 30d threshold)

**Canonical thresholds per requirements (CAL-06):** red <=14 days, amber <=30 days, green >30 days.

Export these:

1. **`UrgencyLevel` type**: `"red" | "amber" | "green" | "none" | "overdue"`

2. **`getUrgencyLevel(dueDateStr: string | undefined, now?: Date): UrgencyLevel`**:
   - If `dueDateStr` is undefined/empty, return `"none"`
   - Parse the date string with `new Date(dueDateStr)`
   - Calculate days until: `Math.ceil((due.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))`
   - `daysUntil <= 0` -> `"overdue"`
   - `daysUntil <= 14` -> `"red"`
   - `daysUntil <= 30` -> `"amber"`
   - else -> `"green"`
   - The `now` parameter defaults to `new Date()` -- it exists for testing determinism.

3. **`urgencyColorClass(level: UrgencyLevel): string`**:
   Returns Tailwind utility classes for each level. Use the app's existing color tokens:
   - `"red"`: `"text-red-400 border-red-500/30 bg-red-500/10"`
   - `"amber"`: `"text-amber-400 border-amber-500/30 bg-amber-500/10"`
   - `"green"`: `"text-chart-2 border-chart-2/30 bg-chart-2/10"` (chart-2 is the app's success/green token)
   - `"overdue"`: `"text-destructive border-destructive/30 bg-destructive/10"`
   - `"none"`: `"text-muted-foreground border-border/50 bg-transparent"`

4. **`daysUntilDate(dueDateStr: string, now?: Date): number`** -- Reusable helper that returns the integer days-until value. Used by urgency internally and useful for display (e.g., "12d left"). Returns negative for overdue dates.

Do NOT import anything from React or any UI library. This is a pure utility module.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the file exports UrgencyLevel, getUrgencyLevel, urgencyColorClass, and daysUntilDate. Verify no React imports exist.
  </verify>
  <done>urgency.ts exports a deterministic urgency calculation with canonical thresholds (red <=14d, amber <=30d, green >30d) and matching Tailwind color classes, ready for use by calendar-grid.ts and future refactoring of the 3 existing duplication sites.</done>
</task>

<task type="auto">
  <name>Task 2: Calendar grid data model (calendar-grid.ts)</name>
  <files>src/lib/engine/calendar-grid.ts</files>
  <action>
Create `src/lib/engine/calendar-grid.ts` with the pure function that reshapes `StrategicAssessment` into a calendar grid structure.

**Exported types:**

```typescript
export interface CalendarSlotData {
  id: string;                    // Unique: `${stateId}-${speciesId}-${type}-${month}`
  itemType: "application" | "point_purchase" | "hunt" | "scout" | "deadline" | "prep";
  title: string;                 // Truncated description (max 50 chars)
  description: string;           // Full description
  stateId: string;
  speciesId: string;
  month: number;                 // 1-12
  day?: number;                  // Specific day if known from dueDate
  endMonth?: number;             // For multi-month spans (hunts)
  endDay?: number;
  estimatedCost: number;
  tagType: "draw" | "otc" | "leftover" | "points_only" | "n/a";
  urgency: UrgencyLevel;         // From urgency.ts
  dueDate?: string;              // ISO date string for deadline proximity display
}

export interface CalendarRow {
  stateId: string;
  stateName: string;
  stateAbbr: string;
  color: string;                 // From State.color for visual identity
  months: Map<number, CalendarSlotData[]>;  // 1-12
}

export interface CalendarGrid {
  year: number;
  rows: CalendarRow[];
  monthlyCosts: number[];        // 12 elements, index 0 = Jan, index 11 = Dec
  totalCost: number;
  availableYears: number[];      // All years in the roadmap, for year selector
}
```

**Main function:** `buildCalendarGrid(assessment: StrategicAssessment, year: number): CalendarGrid`

Implementation details:

1. **Extract available years**: Map `assessment.roadmap` to get all year values. Store in `availableYears`.

2. **Find the target year**: `assessment.roadmap.find(ry => ry.year === year)`. If not found, return an empty grid with the available years populated (so the UI can still render a year selector).

3. **Process roadmap actions**: For each `RoadmapAction` in the target year:
   - Look up state via `STATES_MAP[action.stateId]`. Skip if state not found.
   - Get or create a `CalendarRow` for this state.
   - Determine the month: If `action.dueDate` exists, use `new Date(action.dueDate).getMonth() + 1`. Otherwise derive from action type using `deriveMonthFromActionType()` (see below).
   - Map `action.type` to `itemType`: `"apply"` -> `"application"`, `"buy_points"` -> `"point_purchase"`, `"hunt"` -> `"hunt"`, `"scout"` -> `"scout"`.
   - Derive `tagType` using `deriveTagType()` (see below).
   - Calculate `urgency` via `getUrgencyLevel(action.dueDate)`.
   - Extract `day` from dueDate if present.
   - Build the `CalendarSlotData` and push to the appropriate month slot in the row.

4. **Also process milestones**: For each `assessment.milestones` where `milestone.year === year`:
   - Only include if NOT already represented by a roadmap action (check for matching stateId + speciesId + type to avoid duplicates).
   - Milestones have more precise `dueDate` values, so they add deadline-level items the roadmap may not have.

5. **Calculate monthly costs**: Sum all slot `estimatedCost` values per month across all rows.

6. **Sort rows**: Sort `CalendarRow[]` alphabetically by `stateName` for consistent rendering.

**Helper functions (not exported, internal):**

`deriveMonthFromActionType(action: RoadmapAction): number`:
- `"buy_points"`: Look up `STATES_MAP[action.stateId].applicationDeadlines[action.speciesId]`. If found, use the close date's month. Otherwise default to month 3 (March -- most states have spring deadlines).
- `"apply"`: Same as buy_points (applications share the same deadline window).
- `"hunt"`: Default to month 10 (October -- most western big game seasons).
- `"scout"`: Default to month 7 (July -- pre-season scouting).

`deriveTagType(action: RoadmapAction, state: State): CalendarSlotData["tagType"]`:
- `action.type === "buy_points"` -> `"points_only"`
- `action.type === "scout"` -> `"n/a"`
- `action.type === "apply"` or `"hunt"` -> `"draw"` (default; OTC/leftover detection needs Phase 7 scraper data -- add `// TODO: Phase 7 - derive OTC/leftover from scraper data` comment)

`emptyGrid(year: number, availableYears: number[]): CalendarGrid`:
- Returns a grid with no rows, zero-filled monthlyCosts, totalCost 0, and the provided availableYears.

**Imports:**
- `import type { StrategicAssessment, RoadmapAction, State } from "@/lib/types";`
- `import { STATES_MAP } from "@/lib/constants/states";`
- `import { getUrgencyLevel } from "./urgency";`
- `import type { UrgencyLevel } from "./urgency";`

Do NOT import React or any UI code. This is a pure data transformation module.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the file exports CalendarSlotData, CalendarRow, CalendarGrid, and buildCalendarGrid. Verify it imports from urgency.ts and states.ts correctly. Verify no React imports exist.
  </verify>
  <done>calendar-grid.ts exports a pure buildCalendarGrid function that transforms StrategicAssessment into a CalendarGrid with state rows, month-keyed slot arrays, monthly cost totals, and available years for the year selector. All urgency calculations use the shared urgency.ts utility.</done>
</task>

</tasks>

<technical_notes>
- The `Map<number, CalendarSlotData[]>` for months uses 1-based indexing (1=Jan, 12=Dec) -- NOT 0-based. This matches how months appear in the UI and avoids off-by-one bugs.
- The `availableYears` field on CalendarGrid enables the year selector in the UI without re-reading the assessment.
- Tag type derivation is intentionally conservative: everything is "draw" unless provably otherwise. Phase 7 scraper data will add OTC/leftover detection.
- Milestone deduplication prevents the same action from appearing twice (once from roadmap, once from milestones). Match on stateId + speciesId + type for the same month.
- Month derivation from `applicationDeadlines` uses the `close` date since that is the actual deadline the user cares about.
</technical_notes>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `grep "export function getUrgencyLevel" src/lib/engine/urgency.ts` confirms urgency function exists
- `grep "export type UrgencyLevel" src/lib/engine/urgency.ts` confirms type export
- `grep "export function buildCalendarGrid" src/lib/engine/calendar-grid.ts` confirms grid function exists
- `grep "export interface CalendarGrid" src/lib/engine/calendar-grid.ts` confirms type exports
- `grep "import.*getUrgencyLevel" src/lib/engine/calendar-grid.ts` confirms urgency integration
- `grep "import.*STATES_MAP" src/lib/engine/calendar-grid.ts` confirms state data integration
- Neither file imports from React or any component library
</verification>

<success_criteria>
1. urgency.ts provides canonical urgency thresholds (red <=14d, amber <=30d, green >30d) with Tailwind color classes
2. calendar-grid.ts transforms StrategicAssessment into a CalendarGrid with state rows, month slots, costs, and available years
3. Both files compile with no type errors and have zero UI dependencies
4. Tag type derivation handles all 4 action types with a TODO comment for Phase 7 OTC/leftover enhancement
</success_criteria>

<output>
After completion, create `.planning/phases/03-season-calendar/03-01-SUMMARY.md`
</output>
