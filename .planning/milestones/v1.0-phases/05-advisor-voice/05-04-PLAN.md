---
phase: 05-advisor-voice
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/lib/engine/calendar-grid.ts
  - src/lib/engine/advisor-calendar.ts
  - src/components/results/sections/CalendarSlot.tsx
autonomous: true

must_haves:
  truths:
    - "CalendarSlotData has an optional advisorNote field containing plain-text advisor interpretation"
    - "Calendar advisor notes are generated by a pure function consuming the slot data and assessment context"
    - "Advisor notes appear as tooltips on calendar slots (title attribute or custom tooltip)"
    - "Advisor notes are portfolio-specific -- reference the user's points, draw timeline, and costs"
    - "Calendar advisor notes are plain text (no HTML) for ICS DESCRIPTION compatibility"
    - "ICS builder includes advisor notes in event descriptions when present"
  artifacts:
    - path: "src/lib/engine/advisor-calendar.ts"
      provides: "generateCalendarAdvisorNotes pure function"
      exports: ["generateCalendarAdvisorNotes"]
    - path: "src/lib/engine/calendar-grid.ts"
      provides: "CalendarSlotData with advisorNote field"
      contains: "advisorNote"
    - path: "src/components/results/sections/CalendarSlot.tsx"
      provides: "CalendarSlot rendering advisor notes as tooltips"
      contains: "advisorNote"
  key_links:
    - from: "src/lib/engine/advisor-calendar.ts"
      to: "src/lib/engine/calendar-grid.ts"
      via: "reads CalendarSlotData to produce advisor notes"
      pattern: "CalendarSlotData"
    - from: "src/lib/engine/advisor-calendar.ts"
      to: "src/lib/engine/urgency.ts"
      via: "uses daysUntilDate for deadline proximity in notes"
      pattern: "daysUntilDate"
    - from: "src/components/results/sections/CalendarSlot.tsx"
      to: "src/lib/engine/calendar-grid.ts"
      via: "renders advisorNote from CalendarSlotData"
      pattern: "advisorNote"
---

<objective>
Add advisor voice to season calendar items -- each calendar slot gets a plain-text advisor note that provides interpretation, recommendation, and portfolio context. Notes appear as tooltips in the UI and flow into ICS subscription descriptions.

Purpose: ADV-02 requires advisor voice across the dashboard AND calendar. Calendar items currently show raw data (species, cost, deadline) but no interpretation. This plan adds the "so what?" layer to every calendar slot.

Output: advisor-calendar.ts engine, CalendarSlotData.advisorNote field, CalendarSlot tooltip rendering, ICS description enrichment.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advisor-voice/05-RESEARCH.md
@.planning/phases/05-advisor-voice/05-01-SUMMARY.md
@.planning/phases/05-advisor-voice/05-02-SUMMARY.md
@src/lib/engine/calendar-grid.ts
@src/lib/engine/urgency.ts
@src/lib/calendar/ics-builder.ts
@src/components/results/sections/CalendarSlot.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calendar advisor note generator + CalendarSlotData extension</name>
  <files>src/lib/engine/advisor-calendar.ts, src/lib/engine/calendar-grid.ts</files>
  <action>
**Part A: Extend CalendarSlotData (calendar-grid.ts)**

Add one optional field to the `CalendarSlotData` interface:
```typescript
advisorNote?: string; // Plain-text advisor interpretation for this slot
```

This is the ONLY change to calendar-grid.ts. Do NOT modify buildCalendarGrid or any other function. The advisor notes are attached post-build by a separate function.

**Part B: Create advisor-calendar.ts**

Create `src/lib/engine/advisor-calendar.ts` with:

1. `generateCalendarAdvisorNotes` pure function:
```typescript
export function generateCalendarAdvisorNotes(
  slots: CalendarSlotData[],
  assessment: StrategicAssessment,
  userPoints: UserPoints[],
): CalendarSlotData[]
```

This function takes an array of CalendarSlotData (from a CalendarGrid's rows), enriches each with an `advisorNote`, and returns the enriched array. It does NOT mutate the input -- returns new objects.

2. For each slot, generate a plain-text advisor note based on `itemType` and context:

**application slots:**
- Find user's points for this state+species in userPoints
- Use `daysUntilDate(slot.dueDate)` if dueDate exists
- If days <= 14: "PRIORITY: ${state} ${species} application closes in ${days} days. You have ${pts} points. Submit today -- missing this deadline costs you a year of building."
- If days <= 30: "${state} ${species} application deadline is ${days} days away. You have ${pts} points. Finalize your unit choices and budget."
- If days > 30: "${state} ${species} application opens in ~${days} days. You have ${pts} points. Good time to research units and confirm your strategy."
- If no dueDate: "${state} ${species} application. You have ${pts} points. Check the state F&G website for current deadlines."

**point_purchase slots:**
- "Annual ${species} point purchase in ${state}. Cost: $${cost}. This keeps your draw timeline on track."

**hunt slots:**
- Find the stateRecommendation for this state in assessment
- If found with drawConfidence: "Your ${state} ${species} hunt! Draw confidence: ${confidence}. ${unitCode ? 'Target: Unit ' + unitCode + '.' : ''} Prepare your gear and logistics."
- If no recommendation context: "Your ${state} ${species} hunt is scheduled. Start planning logistics."

**scout slots:**
- "Scouting trip for ${state} ${species}. Use this to familiarize yourself with the terrain before your draw year."

**deadline slots:**
- Same logic as application but phrased as: "Key deadline for ${state} ${species}..."

**prep slots:**
- "Preparation for ${state} ${species}. Review gear lists and travel arrangements."

3. All notes must be plain text -- no HTML, no markdown. Use `\n` for line breaks where helpful (ICS compatibility per Research Pitfall 6). Keep notes concise (max 200 chars).

4. Use `STATES_MAP` for state names/abbreviations and `formatSpeciesName` for species display names.

Import from: `urgency.ts` (daysUntilDate), `calendar-grid.ts` (CalendarSlotData), `types/index.ts` (StrategicAssessment, UserPoints), `constants/states.ts` (STATES_MAP), `utils.ts` (formatSpeciesName).
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Verify advisorNote field exists on CalendarSlotData type.</verify>
  <done>CalendarSlotData has advisorNote optional field. advisor-calendar.ts exports generateCalendarAdvisorNotes that enriches slots with plain-text, portfolio-specific advisor notes.</done>
</task>

<task type="auto">
  <name>Task 2: CalendarSlot tooltip rendering + ICS description enrichment</name>
  <files>src/components/results/sections/CalendarSlot.tsx, src/lib/calendar/ics-builder.ts</files>
  <action>
**Part A: CalendarSlot tooltip (CalendarSlot.tsx)**

Read the current CalendarSlot component to understand its structure. Then:

1. If the `CalendarSlotData` (or the slot's props) has an `advisorNote` field that is non-empty:
   - Add a `title` attribute to the outermost slot element containing the `advisorNote` text. This provides a native browser tooltip on hover.
   - This is the simplest approach and avoids adding a tooltip library dependency. The research recommended "title attribute or custom tooltip" -- use title for now.

2. Do NOT change the existing visual layout or styling of the CalendarSlot. The advisor note is tooltip-only, not inline text (per research: "CalendarSlot is already very compact (8-9px text). Adding advisor text inline would overflow.").

**Part B: ICS description enrichment (ics-builder.ts)**

Read the current ics-builder.ts to find where event DESCRIPTION is built (look for the `buildEnrichedDescription` or similar function that assembles the ICS DESCRIPTION field).

1. If the CalendarSlotData (or the event input) has an `advisorNote` field:
   - Prepend or append the advisor note to the existing DESCRIPTION content
   - Format: `"Advisor: ${advisorNote}\\n\\n${existingDescription}"` (advisor note first, then existing content)
   - Use ICS-safe plain text with `\\n` line breaks

2. If no advisorNote, leave the DESCRIPTION unchanged.

This ensures calendar subscription events (webcal://) carry advisor voice in their descriptions when viewed in Google Calendar, Apple Calendar, etc.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Run `npm run build` to confirm the build succeeds.</verify>
  <done>CalendarSlot shows advisor notes as native tooltips on hover. ICS builder includes advisor notes in event DESCRIPTION for calendar subscription enrichment. Both changes are additive -- no existing behavior modified when advisorNote is absent.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. CalendarSlotData.advisorNote field exists in the type
4. generateCalendarAdvisorNotes produces plain-text notes for each slot type
5. CalendarSlot renders title tooltip when advisorNote is present
6. ICS builder includes advisor note in DESCRIPTION when present
7. Existing calendar rendering unchanged when advisorNote is absent
8. No HTML in advisor notes (ICS safe)
</verification>

<success_criteria>
- CalendarSlotData extended with advisorNote field
- advisor-calendar.ts generates portfolio-specific plain-text notes for every slot type
- CalendarSlot component shows advisor notes as hover tooltips
- ICS subscription events carry advisor notes in DESCRIPTION
- All notes reference user's specific points, states, species, and costs
- No HTML in advisor notes
- Existing calendar visual layout unmodified
- TypeScript compiles, Next.js builds
</success_criteria>

<output>
After completion, create `.planning/phases/05-advisor-voice/05-04-SUMMARY.md`
</output>
