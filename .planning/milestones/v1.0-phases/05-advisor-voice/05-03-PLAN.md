---
phase: 05-advisor-voice
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/advisor/AdvisorCard.tsx
  - src/app/(app)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows an Advisor Insights section replacing the Welcome Back card with up to 7 prioritized insights"
    - "Each insight card shows urgency indicator (color), interpretation text, recommendation text, and a clickable CTA button"
    - "CTA buttons navigate to the correct internal page or external URL"
    - "Urgency colors match canonical tokens: immediate=red-400, soon=amber-400, informational=chart-2, positive=primary"
    - "Portfolio-specific context appears in insight cards (user's states, species, points)"
    - "Temporal context prefix appears when user is returning (daysSinceLastVisit >= 1)"
    - "recordVisit fires after Zustand hydration completes (not during SSR or before hydration)"
    - "Dashboard still renders correctly when user has no plan (no advisor insights, getting started flow unchanged)"
    - "Point creep shift alerts appear in advisor insights when draw timelines have shifted"
  artifacts:
    - path: "src/components/advisor/AdvisorCard.tsx"
      provides: "Reusable advisor insight card component with urgency, interpretation, recommendation, CTA"
      exports: ["AdvisorCard"]
    - path: "src/app/(app)/dashboard/page.tsx"
      provides: "Dashboard page with AdvisorInsights section replacing Welcome Back"
      contains: "generateAdvisorInsights"
  key_links:
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/lib/engine/advisor.ts"
      via: "calls generateAdvisorInsights in useMemo"
      pattern: "generateAdvisorInsights"
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/lib/engine/advisor-temporal.ts"
      via: "calls buildTemporalContext with lastVisitAt"
      pattern: "buildTemporalContext"
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/lib/store.ts"
      via: "reads lastVisitAt and calls recordVisit from useAppStore"
      pattern: "recordVisit|lastVisitAt"
    - from: "src/components/advisor/AdvisorCard.tsx"
      to: "src/lib/types/index.ts"
      via: "renders AdvisorInsight type"
      pattern: "AdvisorInsight"
---

<objective>
Build the AdvisorCard component and rewrite the dashboard to replace the Welcome Back section with the opinionated advisor insights section, making the dashboard speak like an advisor with portfolio-specific interpretations and actionable CTAs.

Purpose: ADV-02 (opinionated dashboard cards), ADV-03 (CTA on every insight), ADV-04 (temporal context), ADV-05 (portfolio-specific), ADV-06 (urgency-calibrated), ADV-07 (point creep alerts), ADV-08 (comments on existing plan). This is the primary user-facing deliverable of Phase 5.

Output: New AdvisorCard component, dashboard page rewritten with advisor insights integration.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advisor-voice/05-RESEARCH.md
@.planning/phases/05-advisor-voice/05-01-SUMMARY.md
@.planning/phases/05-advisor-voice/05-02-SUMMARY.md
@src/app/(app)/dashboard/page.tsx
@src/lib/engine/advisor.ts
@src/lib/engine/advisor-temporal.ts
@src/lib/store.ts
@src/lib/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdvisorCard reusable component</name>
  <files>src/components/advisor/AdvisorCard.tsx</files>
  <action>
Create `src/components/advisor/AdvisorCard.tsx` as a "use client" component:

**Props:** `{ insight: AdvisorInsight }`

**Layout (single card, not a Card component -- lightweight div):**

```
┌──────────────────────────────────────────────┐
│ [urgency dot] [category icon] Interpretation │
│                                              │
│ [portfolioContext if present]                 │
│ [temporalContext if present]                  │
│                                              │
│ Recommendation text                          │
│                                              │
│                        [CTA Button ─────→]   │
└──────────────────────────────────────────────┘
```

**Implementation details:**

1. Urgency color mapping (matches canonical urgency tokens from urgency.ts):
   - `immediate`: `text-red-400`, dot `bg-red-400`, border `border-red-500/20`, bg `bg-red-500/5`
   - `soon`: `text-amber-400`, dot `bg-amber-400`, border `border-amber-500/20`, bg `bg-amber-500/5`
   - `informational`: `text-chart-2`, dot `bg-chart-2`, border `border-chart-2/20`, bg `bg-chart-2/5`
   - `positive`: `text-primary`, dot `bg-primary`, border `border-primary/20`, bg `bg-primary/5`

2. Category icon mapping (using lucide-react icons already imported in dashboard):
   - `deadline`: Clock
   - `portfolio`: Shield
   - `point_creep`: TrendingUp (or TrendingDown if available, else TrendingUp)
   - `discipline`: AlertTriangle
   - `milestone`: Target
   - `temporal`: RefreshCw
   - `calendar`: Calendar

3. Structure:
   - Outer div: `p-3 rounded-xl border transition-all` with urgency bg/border classes
   - Top row: urgency dot (w-2 h-2 rounded-full) + icon (w-4 h-4) + interpretation text (text-sm font-medium)
   - Middle: portfolioContext and temporalContext in text-xs text-muted-foreground italic (only if present)
   - Recommendation: text-xs text-muted-foreground leading-relaxed (NOT italic)
   - CTA: Use a Link (next/link) for internal, `<a>` for external. Style as a small button-like element: `inline-flex items-center gap-1 text-xs font-medium mt-2 px-2.5 py-1 rounded-lg` with urgency text color + hover bg. Include ArrowRight icon (w-3 h-3) for internal, ExternalLink icon for external.

4. If `insight.cta.external` is true, render `<a href={insight.cta.href} target="_blank" rel="noopener noreferrer">`. Otherwise render `<Link href={insight.cta.href}>`.

Keep the component lean -- no internal state, no effects, just props-in render-out. Import types from `@/lib/types`, icons from `lucide-react`, Link from `next/link`.

Do NOT modify the existing `src/components/consultation/shared/AdvisorInsight.tsx` -- that component is for the wizard and is unrelated (per research recommendation).
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Check that the file exists at the expected path.</verify>
  <done>AdvisorCard.tsx exists in src/components/advisor/, renders urgency-colored insight cards with interpretation, recommendation, portfolio context, temporal context, and clickable CTA. No internal state.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard rewrite with advisor insights section</name>
  <files>src/app/(app)/dashboard/page.tsx</files>
  <action>
Modify the existing dashboard page to integrate the advisor voice:

**1. New imports (add to existing import block):**
- `import { generateAdvisorInsights } from "@/lib/engine/advisor";`
- `import { buildTemporalContext } from "@/lib/engine/advisor-temporal";`
- `import { computeBoardState } from "@/lib/engine/board-state";`
- `import { AdvisorCard } from "@/components/advisor/AdvisorCard";`
- `import type { AdvisorInsight as AdvisorInsightType } from "@/lib/types";`

**2. Add lastVisitAt and recordVisit to the store destructuring:**
Add to the useAppStore() destructuring: `lastVisitAt` and `recordVisit`.

**3. Add recordVisit effect (handles Zustand hydration race):**
```typescript
// Record visit AFTER hydration -- avoid overwriting lastVisitAt before store is hydrated
useEffect(() => {
  // useAppStore.persist hydrates from localStorage on mount.
  // The set() inside recordVisit checks same-day, so even if this fires
  // before full hydration, it only writes if the persisted value is from a different day.
  // This is safe because Zustand synchronously restores persisted state before React renders.
  recordVisit();
}, []); // eslint-disable-line react-hooks/exhaustive-deps
```

**4. Build temporal context (useMemo):**
```typescript
const temporal = useMemo(
  () => buildTemporalContext(lastVisitAt),
  [lastVisitAt],
);
```

**5. Build board state (useMemo) -- use existing computeBoardState:**
```typescript
const boardState = useMemo(
  () => confirmedAssessment
    ? computeBoardState(confirmedAssessment, confirmedAssessment.portfolioMandate, violations, userPoints)
    : null,
  [confirmedAssessment, violations, userPoints],
);
```

**6. Generate advisor insights (useMemo):**
```typescript
const advisorInsights: AdvisorInsightType[] = useMemo(() => {
  if (!confirmedAssessment || !boardState || !health || !metrics) return [];
  return generateAdvisorInsights(
    boardState,
    health,
    metrics,
    violations,
    milestones,
    userPoints,
    temporal,
    confirmedAssessment,
  );
}, [confirmedAssessment, boardState, health, metrics, violations, milestones, userPoints, temporal]);
```

**7. Replace the Welcome Back section (the `{welcomeBack && (...)}` block, approximately lines 290-353):**

Replace the entire Welcome Back card with a new Advisor Insights section:

```tsx
{/* ADVISOR INSIGHTS -- replaces Welcome Back */}
{hasPlan && advisorInsights.length > 0 && (
  <Card className="bg-card border-border overflow-hidden">
    <div className="h-1 bg-gradient-to-r from-primary via-chart-2 to-chart-5" />
    <CardContent className="p-4">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Compass className="w-4 h-4 text-primary" />
          <p className="text-sm font-semibold">Your Advisor</p>
        </div>
        {temporal.isReturningUser && temporal.daysSinceLastVisit !== null && temporal.daysSinceLastVisit >= 1 && (
          <span className="text-[10px] text-muted-foreground">
            Last visit: {temporal.daysSinceLastVisit === 1 ? "yesterday" : `${temporal.daysSinceLastVisit} days ago`}
          </span>
        )}
      </div>
      <div className="space-y-2">
        {advisorInsights.map((insight) => (
          <AdvisorCard key={insight.id} insight={insight} />
        ))}
      </div>
    </CardContent>
  </Card>
)}
```

Add `Compass` to the lucide-react imports (it's not currently imported).

**8. Remove the `welcomeBack` useMemo entirely** -- it's fully replaced by advisor insights. Remove the `welcomeBack` variable and the entire `useMemo(() => { if (!hasPlan || milestones.length === 0) return null; ...` block (approximately lines 106-147).

**9. Keep everything else intact:**
- The deadline warning banner stays (it's a separate urgency UI)
- The strategic metrics grid stays
- The mini timeline strip stays
- The action plan section stays
- The apply this year section stays
- The state investment overview stays
- The no-plan/getting-started flow stays unchanged

**Critical: Do NOT break the no-plan state.** When `hasPlan` is false, the advisor insights section simply doesn't render (the `hasPlan && advisorInsights.length > 0` guard handles this).
  </action>
  <verify>Run `npx tsc --noEmit` to confirm compilation. Run `npm run build` to confirm the page builds without errors. Visually inspect the dashboard in the browser to confirm advisor insights appear for users with a plan and the getting-started flow still works for users without a plan.</verify>
  <done>Dashboard page has the Welcome Back section fully replaced with an Advisor Insights section showing up to 7 urgency-prioritized advisor cards with CTAs. recordVisit fires on mount. Temporal context shows for returning users. No-plan state unchanged.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Dashboard with a plan shows "Your Advisor" section with insight cards
4. Each insight card has: urgency color, interpretation, recommendation, CTA button
5. CTA buttons link to correct pages (internal links use Link, external use target="_blank")
6. Dashboard without a plan shows getting-started flow (unchanged)
7. Temporal context appears only for returning users (daysSinceLastVisit >= 1)
8. Point creep insights appear when draw timelines have shifted
9. No plan abandonment language in any insight text
</verification>

<success_criteria>
- AdvisorCard component renders urgency-colored cards with interpretation, recommendation, and CTA
- Dashboard Welcome Back section fully replaced with Advisor Insights
- recordVisit persists visit timestamp after hydration
- generateAdvisorInsights called in useMemo with all required inputs
- No-plan dashboard state unaffected
- All insights portfolio-specific (reference user's states, species, points)
- Urgency colors match canonical tokens
- External CTAs open in new tab; internal CTAs use Next.js Link
- TypeScript compiles, Next.js builds
</success_criteria>

<output>
After completion, create `.planning/phases/05-advisor-voice/05-03-SUMMARY.md`
</output>
