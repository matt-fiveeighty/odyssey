---
phase: 09-diff-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types/index.ts
  - src/lib/engine/diff-engine.ts
  - src/lib/store.ts
autonomous: true

must_haves:
  truths:
    - "computeDiffItems returns categorized, materiality-filtered DiffItem[] from temporal context + current data"
    - "Diff items only generated for returning users (daysSinceLastVisit >= 1)"
    - "Materiality filter suppresses cost changes <$25, deadline shifts <5 days, draw timeline shifts <1 year"
    - "Each diff item has a stable deterministic ID for seen-tracking across sessions"
    - "seenDiffIds and markDiffSeen/markAllDiffsSeen persist in AppState via Zustand"
  artifacts:
    - path: "src/lib/engine/diff-engine.ts"
      provides: "Complete diff computation pipeline: sub-generators, materiality filter, categorization, sorting"
      exports: ["computeDiffItems", "MATERIALITY_THRESHOLDS", "DIFF_CATEGORY_PRIORITY"]
      min_lines: 150
    - path: "src/lib/types/index.ts"
      provides: "DiffItem, DiffSource, DiffCategory type definitions"
      contains: "DiffItem"
    - path: "src/lib/store.ts"
      provides: "seenDiffIds, lastDiffComputedAt state + markDiffSeen, markAllDiffsSeen actions"
      contains: "seenDiffIds"
  key_links:
    - from: "src/lib/engine/diff-engine.ts"
      to: "src/lib/engine/urgency.ts"
      via: "import getUrgencyLevel, daysUntilDate"
      pattern: "getUrgencyLevel|daysUntilDate"
    - from: "src/lib/engine/diff-engine.ts"
      to: "src/lib/engine/advisor-creep.ts"
      via: "import detectCreepShifts"
      pattern: "detectCreepShifts"
    - from: "src/lib/engine/diff-engine.ts"
      to: "src/lib/engine/advisor-temporal.ts"
      via: "import formatTemporalPrefix, TemporalContext"
      pattern: "formatTemporalPrefix|TemporalContext"
---

<objective>
Build the complete diff engine -- types, pure-function pipeline, materiality filter, categorization with advisor voice, and Zustand persistence for seen-tracking.

Purpose: This is the data layer for Phase 9. The diff engine computes what changed since the user's last visit, filters to material changes only, categorizes each item (action_required/opportunity/status_update/warning), and generates advisor-voice interpretation. Following the exact pipeline pattern established by advisor.ts in Phase 5.

Output: DiffItem types, diff-engine.ts pure function module, AppState extensions for seen-tracking.
</objective>

<execution_context>
@/Users/mattramirez/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mattramirez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-diff-view/09-RESEARCH.md

@src/lib/types/index.ts
@src/lib/store.ts
@src/lib/engine/advisor.ts
@src/lib/engine/advisor-temporal.ts
@src/lib/engine/advisor-creep.ts
@src/lib/engine/urgency.ts
@src/lib/constants/states.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DiffItem types and AppState store extensions</name>
  <files>src/lib/types/index.ts, src/lib/store.ts</files>
  <action>
**In src/lib/types/index.ts**, add these types near the existing AdvisorInsight types:

```typescript
export type DiffSource = 'deadline_proximity' | 'draw_result' | 'point_creep' | 'new_opportunity';
export type DiffCategory = 'action_required' | 'opportunity' | 'status_update' | 'warning';

export interface DiffItem {
  id: string;                          // Stable, deterministic: "diff-deadline-CO-elk"
  source: DiffSource;
  category: DiffCategory;
  stateId: string;
  speciesId: string;
  headline: string;                    // Short: "CO Elk deadline now urgent"
  interpretation: string;              // Advisor voice with temporal context
  recommendation: string;              // Actionable next step
  cta: AdvisorCTA;                     // Reuse existing AdvisorCTA type
  delta: number;                       // Change magnitude (for sorting)
  previousValue: string | number;      // What it was at last visit
  currentValue: string | number;       // What it is now
}
```

**In src/lib/store.ts**, add to the AppState interface:

```typescript
// Diff tracking (Phase 9)
seenDiffIds: string[];
lastDiffComputedAt: string | null;
markDiffSeen: (id: string) => void;
markAllDiffsSeen: (ids: string[]) => void;
```

Add to the initial state in the create() call:
```typescript
seenDiffIds: [],
lastDiffComputedAt: null,
```

Add actions:
```typescript
markDiffSeen: (id) =>
  set((state) => ({
    seenDiffIds: state.seenDiffIds.includes(id)
      ? state.seenDiffIds
      : [...state.seenDiffIds, id],
  })),
markAllDiffsSeen: (ids) =>
  set((state) => ({
    seenDiffIds: [...new Set([...state.seenDiffIds, ...ids])],
    lastDiffComputedAt: new Date().toISOString(),
  })),
```

Do NOT bump the persist key (hunt-planner-app-v2). These are nullable/default-empty fields compatible with Zustand's shallow merge.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Grep for `seenDiffIds` in store.ts to confirm the field, action, and initial state are all present. Grep for `DiffItem` in types/index.ts.
  </verify>
  <done>DiffItem, DiffSource, DiffCategory types exported from types/index.ts. AppState has seenDiffIds: string[], lastDiffComputedAt: string | null, markDiffSeen action, markAllDiffsSeen action. No persist key bump.</done>
</task>

<task type="auto">
  <name>Task 2: Diff engine pipeline -- sub-generators, materiality filter, categorization</name>
  <files>src/lib/engine/diff-engine.ts</files>
  <action>
Create `src/lib/engine/diff-engine.ts` following the exact pipeline pattern from advisor.ts. Pure functions, no React, no store, no side effects.

**Constants:**
```typescript
export const MATERIALITY_THRESHOLDS = {
  costChange: 25,           // $25 minimum cost delta
  deadlineShift: 5,         // 5-day minimum deadline zone change
  drawTimelineShift: 1,     // 1-year minimum draw timeline shift
} as const;

export const DIFF_CATEGORY_PRIORITY: Record<DiffCategory, number> = {
  action_required: 0,
  warning: 1,
  opportunity: 2,
  status_update: 3,
};

const MAX_DIFF_ITEMS = 5;
```

**Main pipeline function:**
```typescript
export function computeDiffItems(
  temporal: TemporalContext,
  milestones: Milestone[],
  assessment: StrategicAssessment,
  userPoints: UserPoints[],
  states: State[],
): DiffItem[]
```
Guard: if `!temporal.isReturningUser || temporal.daysSinceLastVisit === null || temporal.daysSinceLastVisit < 1` return [].
Also guard: if assessment.createdAt is available and is newer than lastDiffComputedAt parameter (pass as optional), skip diffs for this session (avoids stale diffs after plan regeneration per Pitfall 3 in research). Since we don't have lastDiffComputedAt in the function signature, add it as an optional 6th parameter.

Call 4 sub-generators, filter by materiality, sort by category priority, cap at MAX_DIFF_ITEMS.

**Sub-generator 1: computeDeadlineDiffs(temporal, milestones, states)**
For each milestone with a dueDate in the future:
- Compute daysNow = daysUntilDate(milestone.dueDate, temporal.currentDate)
- Compute daysAtLastVisit = daysUntilDate(milestone.dueDate, new Date(temporal.lastVisitAt!))
- Get urgency zones: zoneNow = getUrgencyLevel(milestone.dueDate, temporal.currentDate), zoneThen = getUrgencyLevel(milestone.dueDate, new Date(temporal.lastVisitAt!))
- If zoneNow !== zoneThen AND zoneNow is 'red' or 'amber' (zone got MORE urgent), create a raw diff item
- delta = daysAtLastVisit - daysNow (how many days closer)
- Use formatSpeciesName and STATES_MAP for labels
- ID format: `diff-deadline-${stateId}-${speciesId}`

**Sub-generator 2: computeDrawResultDiffs(temporal, states, assessment)**
For each state in assessment.stateRecommendations, check if that state has drawResultDates entries in states.ts. For each species where user has an apply milestone AND the draw result date has passed since lastVisitAt (date was after lastVisit and before/on today), generate a diff.
- Only include species the user is actively pursuing (has stateRecommendation for that state)
- ID format: `diff-draw-${stateId}-${speciesId}`
- category: status_update
- headline: "${stateAbbr} ${speciesName} draw results released"
- recommendation: "Check your draw results and record your outcome."
- cta: { label: "Record Outcome", href: "/goals" }

**Sub-generator 3: computeCreepDiffs(temporal, assessment, userPoints)**
Call existing `detectCreepShifts(assessment, userPoints)` from advisor-creep.ts. For each shift with shiftYears >= MATERIALITY_THRESHOLDS.drawTimelineShift:
- ID format: `diff-creep-${stateId}-${speciesId}`
- delta = shift.shiftYears
- category: warning
- headline: "${stateAbbr} ${speciesName} draw moved to Year ${shift.currentDrawYear}"
- interpretation: use formatTemporalPrefix + "your ${speciesName} draw timeline shifted from Year ${shift.previousDrawYear} to Year ${shift.currentDrawYear} due to point creep."
- recommendation: "Consider applying this cycle to lock in your position, or increase point purchases."
- cta: { label: "Review Draw Timeline", href: "/plan-builder" }

**Sub-generator 4: computeOpportunityDiffs(temporal, assessment, states)**
Detect new application windows that opened since lastVisit. For each state in assessment.stateRecommendations, check if any applicationDeadlines have an open date that falls between lastVisitAt and today (application window opened while user was away).
- Only relevant if the open date exists in states.ts applicationDeadlines[species].open
- ID format: `diff-opportunity-${stateId}-${speciesId}`
- category: opportunity
- headline: "${stateAbbr} ${speciesName} application window now open"
- recommendation: "Application window is open. Review your unit choices and submit before the deadline."
- cta: { label: "Apply Now", href: state.buyPointsUrl, external: true }

**Materiality filter function:**
```typescript
function filterByMateriality(items: DiffItem[]): DiffItem[]
```
- deadline_proximity: delta >= MATERIALITY_THRESHOLDS.deadlineShift
- point_creep: delta >= MATERIALITY_THRESHOLDS.drawTimelineShift
- draw_result: always material (return true)
- new_opportunity: always material (return true)

**Categorization is done inline in each sub-generator** (unlike advisor.ts which has a separate step). Each sub-generator directly assigns the category, headline, interpretation, recommendation, and CTA.

**Interpretation format:** Always start with the temporal prefix from formatTemporalPrefix(temporal), e.g., "Since your last visit (12 days ago), your CO Elk deadline moved from green to amber."

**Sort:** By DIFF_CATEGORY_PRIORITY (action_required first), then by absolute delta descending within same category.

Import only from existing modules:
- `getUrgencyLevel, daysUntilDate` from `@/lib/engine/urgency`
- `detectCreepShifts` from `@/lib/engine/advisor-creep`
- `formatTemporalPrefix, TemporalContext` from `@/lib/engine/advisor-temporal`
- `STATES_MAP` from `@/lib/constants/states`
- `formatSpeciesName` from `@/lib/utils`
- Types from `@/lib/types`
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. The file should export computeDiffItems, MATERIALITY_THRESHOLDS, DIFF_CATEGORY_PRIORITY. Grep to confirm all 4 sub-generators exist (computeDeadlineDiffs, computeDrawResultDiffs, computeCreepDiffs, computeOpportunityDiffs). Run `npm run build` to verify no build errors.
  </verify>
  <done>diff-engine.ts exports computeDiffItems that: (1) returns [] for non-returning users, (2) calls 4 sub-generators covering all DIFF-02 sources, (3) applies materiality filter per DIFF-03 thresholds, (4) assigns categories per DIFF-04, (5) includes advisor voice interpretation starting with temporal prefix, (6) sorts by category priority and caps at 5 items, (7) uses stable deterministic IDs for seen-tracking.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. diff-engine.ts is a pure function module (no imports from React, no store imports, no side effects)
4. DiffItem type reuses existing AdvisorCTA type (not a parallel definition)
5. Store extensions use default empty values compatible with Zustand shallow merge (no persist key bump)
</verification>

<success_criteria>
- computeDiffItems returns DiffItem[] with all 4 diff sources (DIFF-02)
- Materiality thresholds match requirements: $25, 5 days, 1 year (DIFF-03)
- Categories match requirements: action_required, opportunity, status_update, warning (DIFF-04)
- seenDiffIds and markDiffSeen/markAllDiffsSeen exist in AppState (DIFF-05)
- All existing tests still pass
- Build succeeds with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-diff-view/09-01-SUMMARY.md`
</output>
